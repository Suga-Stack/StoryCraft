# 软件工程项目规范文档

## 1. 通用规范

### 1.1 项目结构
```
StoryCraft/
├── src/                    # 源代码
│   ├── frontend/          # 前端代码 (Vue3 + Vite)
│   └── backend/           # 后端代码 (Django)
├── docs/                  # 文档
```

### 1.2 Git规范

#### 1.2.1 Git分支规范

1. 前期分前后端两条分支frontend-dev、backend-dev, 每个人基于创建在自己的姓名分支（如pq/app-frontend、ssr/app-backend）进行开发并及时同步到frontend-dev、backend-dev。

2. 后期前后端对接，拉取backend-dev、frontend-dev创建测试分支进行直接修改，确认无误后merge到main分支里。

#### 1.2.2 Git Commit 规范

使用 VSCode `git-commit-plugin`插件，具体规则如下：

| Type     | Description                                                                 |
|----------|-----------------------------------------------------------------------------|
| feat     | A new feature                                                               |
| fix      | A bug fix                                                                   |
| docs     | Documentation only changes                                                  |
| style    | Changes that do not affect the meaning of the code (white-space, formatting, missing semi-colons, etc) |
| refactor | A code change that neither fixes a bug nor adds a feature                   |
| perf     | A code change that improves performance                                     |
| test     | Adding missing or correcting existing tests                                 |
| chore    | Changes to the build process or auxiliary tools and libraries such as documentation generation |

注意：
- 仅需填写`<type>` `<scope>` `<subject>`三个字段，`<type>`为上述固定值之一，`<scope>` `<subject>`均用中文填写

#### 1.2.3 Git合并规范

1. 创建 Pull Request
2. 至少1名团队成员审查
3. 解决审查意见
4. 合并到目标分支

---

## 2. JavaScript/TypeScript 规范

### 2.1 文件与命名
```typescript
// 文件命名 - kebab-case
user-service.ts
login-component.vue

// 变量/函数-命名语义化 - camelCase
const userName = 'John'
function getUserInfo() { }
const isActive = true

// 类/接口/类型 - PascalCase
class UserService { }
interface UserModel { }
type ApiResponse<T> = { data: T }

// 常量 - UPPER_SNAKE_CASE
const API_BASE_URL = 'https://api.example.com'
const MAX_RETRY_COUNT = 3
```

### 2.2 类型规范 (TypeScript)
```typescript
// 明确类型定义
interface User {
  id: number
  name: string
  email: string
  isActive?: boolean  // 可选属性
}

type ApiResponse<T> = {
  data: T
  status: number
  message?: string
}

// 函数类型声明
const getUserById = async (id: number): Promise<User> => {
  // 实现
}

// 避免使用 any
// const data: any = response  // 不好的做法
const data: ApiResponse<User> = response  // 好的做法
```

### 2.3 函数设计原则
```javascript
// 要求单一职责，函数短小，控制代码行数
function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(email)
}

// 函数职责过多
function processUserDataAndSendEmail(user) {
  // 验证数据
  // 保存到数据库
  // 发送邮件
  // 记录日志
  // ...
}

// 参数过多
function createUser(name, email, phone, address, isActive, role, sendEmail) {
  // ...
}
```

### 2.4 代码风格
```typescript
// 使用 const/let，避免 var
const baseUrl = 'https://api.example.com'
let retryCount = 0

// 箭头函数
const add = (a: number, b: number): number => a + b

// 模板字符串
const message = `Hello, ${userName}! Welcome back.`

// 解构赋值
const { id, name, email } = user
const [firstItem, ...restItems] = items

// 使用 === 和 !==
if (status === 'active') { /* ... */ }

// 统一使用单引号，不使用分号
const name = '张三'
```

### 2.5 代码格式
```javascript
// 使用 K&R 风格括号
function example() {
  // 函数体
}

// 操作符前后加空格
const result = a + b

// 缩进：统一使用 2个空格
// 行宽：每行代码不超过 100 个字符
// 结尾：不使用分号
// ...
```

### 2.6 注释规范
```typescript
/**
 * 用户服务类 - 处理用户相关业务逻辑
 */
class UserService {
  /**
   * 根据ID获取用户信息
   * @param userId - 用户ID
   * @returns 用户信息Promise
   * @throws {Error} 当用户不存在时抛出错误
   */
  async getUserById(userId: number): Promise<User> {
    // 缓存检查 - 提高性能
    if (this.cache.has(userId)) {
      return this.cache.get(userId)
    }
    
    // 从API获取用户数据
    const response = await fetch(`${API_BASE_URL}/users/${userId}`)
    return response.json()
  }
}
```

### 2.7 ESLint & Prettier 配置

#### .eslintrc.cjs
```javascript
/* eslint-env node */
require('@rushstack/eslint-patch/modern-module-resolution')

module.exports = {
  root: true,
  extends: [
    'plugin:vue/vue3-essential',
    'eslint:recommended',
    '@vue/eslint-config-typescript',
    '@vue/eslint-config-prettier/skip-formatting'
  ],
  parserOptions: {
    ecmaVersion: 'latest'
  },
  env: {
    node: true,
    browser: true,
    es2021: true
  },
  rules: {
    'no-unused-vars': 'warn',
    'no-empty': 'warn',
    'no-undef': 'warn',
    'no-constant-condition': 'warn',
    'no-inner-declarations': 'off',
    'no-useless-escape': 'off',
    'no-self-assign': 'warn',
    'no-prototype-builtins': 'off',
    'no-useless-catch': 'warn',
    'vue/no-unused-vars': 'warn',
    'vue/multi-word-component-names': 'off',
    'vue/no-parsing-error': 'warn',
    'vue/no-duplicate-attributes': 'warn',
    '@typescript-eslint/no-unused-vars': 'warn'
  }
}
```

#### .prettierrc.cjs
```javascript
module.exports = {
  $schema: 'https://json.schemastore.org/prettierrc',
  semi: false,
  tabWidth: 2,
  singleQuote: true,
  printWidth: 100,
  trailingComma: 'none'
}
```

---

## 3. Python 规范

### 3.1 命名规范
```python
# 变量/函数 - snake_case
user_name = "John"
def get_user_info():
    pass

# 类 - PascalCase
class UserService:
    pass

# 常量 - UPPER_SNAKE_CASE
API_BASE_URL = "https://api.example.com"
MAX_RETRY_COUNT = 3

# 模块名 - 小写字母，短横线分隔
# user_service.py
# data_processor.py
```

### 3.2 代码风格
```python
# 导入规范
import os
import sys
from typing import List, Dict, Optional

# 第三方库
import requests
from flask import Flask

# 本地模块
from .models import User

# 类型提示
def get_user_by_id(user_id: int) -> Optional[User]:
    """根据ID获取用户信息"""
    pass

# 使用f-string
message = f"Hello, {user_name}! Welcome back."

# 列表推导式（适度使用）
active_users = [user for user in users if user.is_active]

# 上下文管理器
with open('file.txt', 'r') as f:
    content = f.read()
```

### 3.3 注释与文档字符串
```python
class UserService:
    """用户服务类，处理用户相关业务逻辑"""
    
    def get_user_by_id(self, user_id: int) -> Optional[User]:
        """
        根据用户ID获取用户信息
        
        Args:
            user_id: 用户ID
            
        Returns:
            User对象，如果用户不存在则返回None
            
        Raises:
            DatabaseError: 数据库查询失败时抛出
            
        Example:
            >>> user = user_service.get_user_by_id(123)
            >>> print(user.name)
        """
        try:
            return self.db.session.query(User).filter_by(id=user_id).first()
        except DatabaseError as e:
            logger.error(f"查询用户失败: {e}")
            raise
```

### 3.4 Ruff配置(pyproject.toml)
```toml
[tool.ruff]
# 排除的文件和目录
exclude = [
    ".bzr",
    ".direnv",
    ".eggs",
    ".git",
    ".git-rewrite",
    ".hg",
    ".ipynb_checkpoints",
    ".mypy_cache",
    ".nox",
    ".pants.d",
    ".pyenv",
    ".pytest_cache",
    ".pytype",
    ".ruff_cache",
    ".svn",
    ".tox",
    ".venv",
    ".vscode",
    "__pypackages__",
    "_build",
    "buck-out",
    "build",
    "dist",
    "node_modules",
    "site-packages",
    "venv",
    "**/migrations/*.py",  # 忽略 Django 迁移文件
    "**/prompts.py",       # 忽略 prompts.py
]

# 行长限制
line-length = 120
indent-width = 4

# 目标 Python 版本
target-version = "py313"

[tool.ruff.lint]
# 启用的规则集
# E: pycodestyle errors
# F: Pyflakes
# I: isort (导入排序)
# W: pycodestyle warnings
select = ["E", "F", "I", "W"]

# 忽略的规则
# E501: Line too long
# E701: Multiple statements on one line (colon)
ignore = ["E501", "E701"]

# 允许自动修复的规则
fixable = ["ALL"]
unfixable = []

[tool.ruff.lint.per-file-ignores]
"**/settings.py" = ["E402"]
"users/views.py" = ["E722"]
"**/tests/*" = ["F841", "W293", "W291"]
"**/test_*.py" = ["F841", "W293", "W291", "E501"]

[tool.ruff.format]
# 使用双引号
quote-style = "double"
# 缩进风格
indent-style = "space"
# 跳过魔术尾随逗号
skip-magic-trailing-comma = false
# 行尾符
line-ending = "auto"
```

---

## 4. HTML/CSS 规范

### 4.1 HTML 规范
```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>页面标题 - 网站名称</title>
  
  <!-- CSS 文件 -->
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <!-- 使用语义化标签 -->
  <header class="site-header">
    <nav class="main-nav" aria-label="主导航">
      <ul class="nav-list">
        <li class="nav-item">
          <a href="/" class="nav-link">首页</a>
        </li>
      </ul>
    </nav>
  </header>
  
  <main class="main-content">
    <article class="content-article">
      <h1 class="article-title">文章标题</h1>
      <section class="article-section">
        <p class="article-text">段落内容</p>
      </section>
    </article>
  </main>
  
  <footer class="site-footer">
    <p class="copyright">&copy; 2023 公司名称</p>
  </footer>
</body>
</html>
```

### 4.2 CSS 命名规范 (BEM)
```css
/* Block - 块 */
.site-header { /* ... */ }

/* Element - 元素 */
.site-header__logo { /* ... */ }
.site-header__nav { /* ... */ }

/* Modifier - 修饰符 */
.site-header--fixed { /* ... */ }
.button--disabled { /* ... */ }

/* 实际示例 */
.user-card { /* 块 */ }
.user-card__avatar { /* 元素 */ }
.user-card__name { /* 元素 */ }
.user-card--highlighted { /* 修饰符 */ }

.article {
  max-width: 800px;
  margin: 0 auto;
  padding: 20px;
}

.article__title {
  font-size: 2rem;
  color: #333;
  margin-bottom: 1rem;
}

.article__meta {
  font-size: 0.875rem;
  color: #666;
  border-bottom: 1px solid #eee;
  padding-bottom: 1rem;
}
```

### 4.3 CSS 组织架构
```css
/* 1. 变量定义 */
:root {
  --primary-color: #007bff;
  --text-color: #333;
  --border-radius: 4px;
  --spacing-unit: 8px;
}

/* 2. 重置样式 */
* { box-sizing: border-box; }
body { margin: 0; font-family: sans-serif; }

/* 3. 工具类 */
.text-center { text-align: center; }
.mt-1 { margin-top: var(--spacing-unit); }
.d-flex { display: flex; }

/* 4. 组件样式 */
.button {
  display: inline-block;
  padding: 8px 16px;
  border: none;
  border-radius: var(--border-radius);
  background-color: var(--primary-color);
  color: white;
  cursor: pointer;
}

/* 5. 页面特定样式 */
.home-page { /* ... */ }
```

---

## 5. 跨语言协作规范

### 5.1 接口规范

- 使用Swagger撰写接口文档，包括请求方法、URL、参数、响应格式等信息
- 前后端统一使用JSON作为数据交换格式

### 5.2 数据格式规范
```json
// 统一响应格式
{
  "code": 200,
  "message": "success",
  "data": {
    "users": [],
    "pagination": {
      "page": 1,
      "total": 100
    }
  }
}

// 错误响应格式
{
  "code": 400,
  "message": "参数验证失败",
  "errors": [
    {
      "field": "email",
      "message": "邮箱格式不正确"
    }
  ]
}
```

### 5.3 环境配置
```bash
# 环境变量命名规范
# 所有语言统一使用 UPPER_SNAKE_CASE

# 数据库
DATABASE_URL=postgresql://user:pass@localhost/dbname

# API
API_BASE_URL=https://api.example.com
API_TIMEOUT=30000

# 功能开关
FEATURE_NEW_AUTH_ENABLED=true
```

---

## 6. 参考清单

### 代码提交前检查
- 代码符合相应语言规范
- 通过所有静态检查（ESLint、Pylint等）
- 代码经过格式化（Prettier、Black、Clang-Format）
- 相关测试通过
- 文档已更新（如有需要）

### 新文件创建模板
- 包含适当的文件头注释
- 遵循项目命名约定
- 放置在正确的目录结构中
- 包含必要的导入/引用

### 代码审查要点
- 是否符合多语言规范
- 命名是否清晰一致
- 错误处理是否适当
- 是否有安全风险
- 性能考虑是否充分

---

*本文档应作为项目开发的基准规范，所有团队成员必须遵守。如有特殊情况需要偏离规范，需经过团队讨论并记录原因。*