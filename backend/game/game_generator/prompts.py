import re

def build_core_seed_prompt(
    tags: list[str],
    idea: str,
    total_chapters: int
) -> str:
    return f"""
# 任务总览
你是一位资深文字冒险游戏编剧。请根据提供的核心信息，为一款新的基于对话选择的文字冒险游戏生成基础设定。

# 核心信息
- 核心标签: {', '.join(tags)}
- 核心构思: {idea if idea else '无特定构思，请根据标签自由发挥'}
- 总章节数: {total_chapters}
- 游戏风格：第二人称沉浸式

# 生成内容
1. 一个吸引人的游戏标题，简洁，概括力强。
2. 一段引人入胜的游戏剧情简介，大约100-150字。
3. 核心冲突：用单句公式概括游戏剧情本质，例如："作为一名[玩家身份]，你突然遭遇[核心事件]，必须[关键行动]，在这个过程中你将面临[主要挑战类型]的考验。"
4. 体验重点：包括：
  - 主要情感体验：[如：悬疑紧张、温馨治愈、热血冒险]
  - 自我发现旅程：通过选择了解自己的决策风格，同时获得游戏趣味
  - 核心互动形式：[如：对话选择、情境反应、道德抉择等]
5. 叙事特色：包括：
  - 沉浸感设计：[如何增强玩家代入感的具体方法]
  - 节奏控制：[如何合理控制章节间的节奏，保持玩家紧张感或期待感等]
  - 情感锚点：[让玩家产生情感共鸣的关键场景]
6. 玩家定位：明确玩家在游戏中的角色身份、初始处境、以及与其他角色的基本关系。

# 特别注意
- 生成的标题和简介旨在吸引读者注意，因此仅需简要概括，点到为止。
- 剧情核心冲突（故事本质）是全部章节剧情的核心"种子”，需具有高度概括性和冲突性，旨在为创作者提供一个清晰的故事主线和冲突基础。

# 格式要求
请严格按照以下格式返回结果，用中文输出，输出纯文本，不要输出任何解释：
[标题]：xxxx
[简介]：xxxx
[核心冲突]：xxxx
[体验重点]：xxxx
[叙事特色]：xxxx
[玩家定位]：xxxx
"""

def build_attribute_prompt(
    core_seed: str
) -> str:
    return f"""
# 任务总览
你是一位资深文字冒险游戏数值策划。请根据提供的游戏核心，设定玩家属性系统。

# 游戏核心
{core_seed}

# 属性维度设计
请设计4-6个核心属性，每个属性包含：
- 属性名称：[如"洞察力"]
- 定义说明：影响玩家什么方面的能力
- 初始值建议：15-25之间的具体数值
- 成长意义：该属性提升对游戏体验的影响
- 关键场景：在游戏中哪些情境下会用到此属性

# 数值平衡规则
- 初始总值限制：100点（4属性各25点，或5属性各20点等）
- 软性限制：避免某个属性过于强势

# 属性互动设计
为每个属性设计：
- 2个正向应用场景（属性高时的优势）

# 输出格式
请严格按以下表格形式输出（实际属性可与以下表格中属性不同），用中文输出，输出纯文本，不要输出任何解释：
| 属性 | 初始值 | 定义 | 关键应用 | 成长影响 |
|------|--------|------|----------|----------|
| 智力 | 20 | 逻辑分析和问题解决能力 | 解谜、推理、学习 | 解锁复杂对话选项 |
| 魅力 | 25 | 社交影响和说服力 | 谈判、建立关系 | 获得NPC更多帮助 |
| 勇气 | 18 | 面对危险时的决断力 | 冒险决策、对抗 | 解锁高风险高回报选项 |
| 洞察 | 22 | 观察细节和直觉判断 | 发现线索、识破谎言 | 提前获得关键信息 |
| 同理心 | 15 | 理解他人情感的能力 | 安慰、调解冲突 | 深化角色关系发展 |
"""

def build_character_dynamics_prompt(
    core_seed: str,
    attribute_system: str
) -> str:
    return f"""
# 任务总览
你是一位资深的文字冒险游戏编剧，请根据提供的游戏核心设定和属性系统，设计3-4个与玩家深度互动的核心角色。

# 游戏核心设定
{core_seed}

# 游戏属性系统
{attribute_system}

# 角色设计框架
每个角色包含：
- 角色姓名：[姓名]
- 身份标签：[简洁的身份描述，如"神秘导师"、"竞争对手"、"可靠盟友"]
- 与玩家关系：[初始关系+发展可能性]
- 核心互动模式：[如何与玩家互动，如"提供线索"、"制造冲突"、"情感支持"]
- 属性关联：[与哪些玩家属性产生互动]
- 关键选择点：[在哪些时刻会影响玩家的重要选择]

# 角色网络设计
- 角色间关系：简单的冲突或合作网络
- 与主线的关联：每个角色如何推动主线发展
- 情感权重：哪个角色承载最重要的情感体验

# 对话风格指引
为每个角色定义独特的对话风格，确保在第二人称叙事中保持一致性。

# 注意
避免复杂的角色背景故事，重点设计他们如何与"你"(玩家)互动。

# 格式要求
仅给出最终文本，用中文输出，不要输出任何解释。
"""

def _calculate_narrative_structure(total_chapters: int):
    """根据章节数量计算叙事结构参数"""
    
    # 规模分类
    if total_chapters <= 5:
        scale_type = "短篇体验"
        scale_description = "紧凑叙事，快速情感建立"
    elif total_chapters <= 10:
        scale_type = "中篇故事" 
        scale_description = "平衡发展，完整情感弧线"
    else:
        scale_type = "长篇冒险"
        scale_description = "丰富层次，深度角色发展"
    
    # 阶段划分计算
    if total_chapters <= 3:
        # 超短篇：引入→高潮→收尾
        stage_breakdown = """
【阶段一：快速建立】（第1章）
- 目标：极速建立玩家代入感和核心冲突
- 情感：好奇→投入

【阶段二：集中高潮】（第2章）
- 目标：核心情感爆发和关键选择，为结局铺垫
- 情感：紧张→释放

【阶段三：多结局展开】（第3章）
- 目标：根据玩家属性呈现不同结局分支（3-4个）
- 情感：根据结局变化（满足/遗憾/希望）
"""
    elif total_chapters <= 6:
        stage_breakdown = f"""
【阶段一：建立联结】（第1章）
- 目标：快速建立核心关系和初始目标
- 情感：好奇→初步投入

【阶段二：核心挑战】（{'第2章' if total_chapters == 4 else f'第2-{total_chapters-2}章'}）
- 目标：集中展现主要冲突和属性变化
- 情感：紧张→成长

【阶段三：结局铺垫】（第{total_chapters-1}章）
- 目标：为多结局做情感和逻辑准备
- 情感：期待→紧张

【阶段四：多结局展开】（第{total_chapters}章）
- 目标：根据属性呈现不同结局分支（3-4个）
- 情感：根据结局变化
"""
    elif total_chapters <= 10:
        # 中篇：完整四阶段
        development_end = int(total_chapters * 0.45) # 3或4
        stage_breakdown = f"""
【阶段一：建立联结】（第1章）
- 目标：建立玩家与角色、世界的深度联结
- 情感：好奇→情感投入

【阶段二：挑战成长】（第2-{development_end}章）
- 目标：通过系列挑战促进属性成长
- 情感：紧张→成就感

【阶段三：关系深化】（{'第4章' if total_chapters == 7 else f'第{development_end+1}-{total_chapters-3}章'}）
- 目标：深化角色关系，准备情感高潮
- 情感：复杂→情感累积

【阶段四：结局铺垫】（第{total_chapters-2}-{total_chapters-1}章）
- 目标：多层次情感爆发和重大选择，为多结局做情感和逻辑准备
- 情感：激烈→期待

【阶段五：多结局展开】（第{total_chapters}章）
- 目标：根据玩家属性呈现不同结局分支（3-4个）
- 情感：根据结局变化（满足/遗憾/希望）
"""
    else:
        # 长篇：丰富层次
        development1_end = int(total_chapters * 0.37) # 4或5
        development2_end = int(total_chapters * 0.55)
        stage_breakdown = f"""
【阶段一：世界建立】（第1-2章）
- 目标：深度建立世界观和核心角色关系
- 情感：探索→初步联结

【阶段二：成长挑战】（第3-{development1_end}章）
- 目标：基础属性成长和初步冲突
- 情感：挑战→小成就

【阶段三：关系发展】（第{development1_end+1}-{development2_end}章）
- 目标：深化角色关系和情感复杂度
- 情感：复杂→情感投资

【阶段四：危机累积】（第{development2_end+1}-{total_chapters-3}章）
- 目标：累积紧张感，为高潮做准备
- 情感：压力→期待

【阶段五：结局铺垫】（第{total_chapters-2}-{total_chapters-1}章）
- 目标：多层次情感爆发和重大选择，为结局准备
- 情感：激烈→释放→期待

【阶段六：多结局展开】（第{total_chapters}章）
- 目标：根据玩家属性呈现不同结局分支（3-4个）
- 情感：根据结局变化（满足/希望/反思）
"""
    
    # 规模特异性设计
    scale_specific_design = ""
    if total_chapters <= 3:
        scale_specific_design = "**超短篇设计重点**：\n- 极速情感建立：第一章就要让玩家产生强烈代入感\n- 集中爆发：所有情感权重集中在第2章\n- 情感收束：第3章专注于展示结局"
    elif total_chapters <= 6:
        scale_specific_design = "**短篇设计重点**：\n- 快速但不仓促：在有限章节内完成完整情感弧线\n- 选择精炼：每个选择都要有明确的情感权重\n- 属性聚焦：重点展示2-3个核心属性的成长"
    elif total_chapters <= 10:
        scale_specific_design = "**中篇设计重点**：\n- 平衡发展：确保每个阶段都有足够的情感发展空间\n- 关系深度：有空间发展1-2个深度角色关系\n- 节奏控制：避免前期过于平淡或后期过于仓促"
    else:
        scale_specific_design = "**长篇设计重点**：\n- 层次丰富：可以设计多层次的情感发展和角色弧光\n- 渐进成长：属性成长和关系变化更加细腻"
    
    return {
        "scale_type": scale_type,
        "scale_description": scale_description,
        "stage_breakdown": stage_breakdown,
        "scale_specific_design": scale_specific_design
    }

def build_game_architecture_prompt(
    core_seed: str,
    attribute_system: str,
    characters: str,
    total_chapters: int
) -> str:
    structure = _calculate_narrative_structure(total_chapters)
    return f"""
# 任务总览
你是一位资深的文字冒险游戏编剧，请根据给定的游戏核心设定、角色属性系统、人物设定为{total_chapters}章的文字冒险游戏设计叙事架构。

# 游戏核心设定
{core_seed}

# 属性系统
{attribute_system}

# 人物设定
{characters}

# 章节规模
共{total_chapters}章，{structure["scale_type"]}（{structure["scale_description"]}）

# 叙事曲线
{structure["stage_breakdown"]}

# 规模设计原则
{structure["scale_specific_design"]}

# 架构设计原则
为确保体验完整性：
1. 核心情感弧线：无论章节多少，都要包含"建立→发展→高潮→结局"的完整流程
2. 关键体验保障：确保以下核心体验点得到覆盖：
   - 玩家与至少1个核心角色的深度联结
   - 至少2次有意义的属性成长展示
   - 1个让玩家印象深刻的情感高潮
   - 最后一章进入结局
3. 情感高潮分布：根据章节数量设置一个或多个情感峰值，每个峰值都为最终结局做铺垫
4. 节奏密度控制：章节越少，情感节奏越紧凑；章节越多，情感层次越丰富

# 选择点设计原则
- 每个选择仅会影响属性值，选择越重大，对属性值影响越大
- 选择不会影响最后一章结局之前的主线剧情，仅在最后一章才会根据属性值判定多结局，确保选择后能在3句话内回归主线

# 输出内容
请你糅合以上各种设定，给出一个合理的叙事架构。

# 输出格式要求
请严格按照以下结构和格式输出，输出纯文本，用中文输出，不要输出任何解释：
## 阶段详细规划

### 阶段一：[阶段名称]
**章节范围**：第[起始章]-[结束章]章
**核心目标**：[此阶段要达成的核心叙事目标]
**情感基调**：[主要的情感氛围]
**情感发展**：[从什么情感状态发展到什么状态]
**关键任务**：
- 任务1：[具体要完成的内容]
- 任务2：[具体要完成的内容]
- 任务3：[具体要完成的内容]
**重要选择**：
- [选择情境]：[影响说明]
- [选择情境]：[影响说明]
**属性聚焦**：[此阶段重点展示哪些属性，列出属性，用逗号分开]
**角色发展**：[此阶段重点发展哪些角色关系]
**结局铺垫**：[如何为多结局建立基础]

### 阶段二：[阶段名称]
**章节范围**：第[起始章]-[结束章]章
**核心目标**：[此阶段要达成的核心叙事目标]
**情感基调**：[主要的情感氛围]
**情感发展**：[从什么情感状态发展到什么状态]
**关键任务**：
- 任务1：[具体要完成的内容]
- 任务2：[具体要完成的内容]
- 任务3：[具体要完成的内容]
**重要选择**：
- [选择情境]：[影响说明]
- [选择情境]：[影响说明]
**属性聚焦**：[此阶段重点展示哪些属性，列出属性，用逗号分开]
**角色发展**：[此阶段重点发展哪些角色关系]
**结局铺垫**：[如何为多结局建立基础]

[根据实际阶段数量继续...]

---
**注意**：请确保所有章节编号、阶段范围与实际总章数 {total_chapters} 一致，避免出现超出范围的章节引用。
"""

def build_chapter_directory_prompt(
    core_seed: str,
    attribute_system: str,
    characters: str,
    architecture: str,
    total_chapters: int
) -> str:
    """
    构建章节目录生成提示词
    """
    return f"""
# 任务概述
你是一位专业的文字冒险游戏编剧，需要为{total_chapters}章的游戏生成具体的章节目录。

# 核心约束信息（必须严格遵守）

## 游戏核心设定
{core_seed}

## 游戏属性系统
{attribute_system}

## 主要角色设定
{characters}

# 完整叙事框架
{architecture}

# 生成内容
请你糅合以上所有要求和设定，设计出一个合理的章节目录。

# 生成要求

## 每章目录格式
每章必须严格按照以下格式输出，不要输出任何解释：
### 第X章 - [章节标题]
**本章定位**：[基于架构中的阶段定位，如"危机建立"/"关系深化"/"真相揭露"]
**情感基调**：[由阶段情感基调分析出本章具体的情感基调]
**核心作用**：
- 情节推进：[具体说明本章要推进什么情节]
- 属性展示：[展示哪些属性，如何展示]
- 关系发展：[发展哪些角色关系，如何发展]
**关键任务完成**：[本章完成架构中哪些关键任务]
**悬念设计**：[低/中/高] - [具体悬念描述]
**伏笔操作**：[埋设/强化/回收] [具体伏笔内容]
**选择点设计**：
- 位置1：[选择情境描述]
  → 选项A：[选项描述] [影响属性：属性名±值]
  → 选项B：[选项描述] [影响属性：属性名±值] 
- 位置2：[选择情境描述]
  → 选项A：[选项描述] [影响属性：属性名±值]
  → 选项B：[选项描述] [影响属性：属性名±值]
**章节大纲**：[100-150字的情节概要，确保与前后章衔接]

## 生成规则

### 结构遵守
- 必须严格遵循架构中的阶段划分和章节范围
- 每章的情感基调要符合所属阶段的情感基调描述
- 确保完成架构中为该阶段设定的关键任务

### 属性整合
- 每章至少重点展示1-2个属性
- 确保各属性在整个游戏中得到均衡展示机会

### 角色发展
- 每章至少与1-2个核心角色有深度互动
- 角色关系发展要符合架构中的路径规划

### 选择点设计原则
1. 每章1-2个选择点
2. 每个选择点提供2-3个选项
3. 每个选项的属性影响值保证在±2到±8点之间
4. 选项间体现不同的价值观倾向
5. 属性影响要合理且有意义
6. 该选择是否重大仅体现在对属性值的影响上，选择越重大，对属性值影响越大
7. 选择不会影响结局之前的主线剧情，仅在最后一章才会根据属性值判定多结局，确保选择后能在3句话内回归主线

### 技术实现约束
- 每章字数目标：2000字
- 特别注意：第{total_chapters}章（最后一章）必须设计为多结局模式。请在章节大纲中明确指出“本章将根据玩家属性达成不同结局”，并简要列举可能的结局方向（3-4个）（如：完美结局、普通结局、遗憾结局）。

# 输出格式
请生成{total_chapters}章的完整目录，从第1章到第{total_chapters}章，严格按照上述每章格式输出。
"""

def extract_chapter_from_directory(chapter_directory: str, chapter_index: int) -> str:
    """从章节目录文本中提取指定章节的详细设定信息"""
    if not chapter_directory:
        return "暂无目录信息"

    # ^(?:#+\s*)?  : 行首可选的 Markdown 标题标记 (#)
    # 第\s*(\d+)\s*章 : 匹配 "第1章", "第 1 章" 等，捕获数字
    pattern = re.compile(r"^(?:#+\s*)?第\s*(\d+)\s*章", re.MULTILINE)
    
    matches = list(pattern.finditer(chapter_directory))
    
    start_pos = -1
    end_pos = -1
    
    for i, m in enumerate(matches):
        try:
            idx = int(m.group(1))
        except ValueError:
            continue
            
        if idx == chapter_index:
            start_pos = m.start()
            # 结束位置是下一章的开始，或者是文本末尾
            if i + 1 < len(matches):
                end_pos = matches[i+1].start()
            else:
                end_pos = len(chapter_directory)
            break
            
    if start_pos != -1:
        return chapter_directory[start_pos:end_pos].strip()
    
    return f"（未在目录中找到第 {chapter_index} 章的详细设定，请根据全局架构自由发挥）"


def build_chapter_prompt(
    chapter_index: int,
    chapter_directory: str, 
    core_seed: str,
    attribute_system: str,
    characters: str, 
    architecture: str,
    previous_chapter_content: str = None,  
    global_summary: str = None  # 累积的全局摘要
) -> str:
    
    # 从章节目录提取本章特定信息
    chapter_info = extract_chapter_from_directory(chapter_directory, chapter_index)
    next_chapter_info = extract_chapter_from_directory(chapter_directory, chapter_index + 1)

    if "未在目录中找到" in next_chapter_info:
        next_chapter_info = "（这是最后一章或无下一章信息）"

    return f"""
# 任务概述
你正在创作文字冒险游戏的第 {chapter_index} 章。请基于以下设定生成具体章节剧情，特别注意将选择点自然地嵌入到对话和情境中。

{f'## 前文摘要\n{global_summary}\n' if global_summary else ''}
{f'## 前一章结尾\n{previous_chapter_content[-500:]}\n' if previous_chapter_content else ''}

## 本章定位
{chapter_info}

## 下一章定位
{next_chapter_info}

# 上下文信息

## 游戏核心设定
{core_seed}

## 主要角色设定
{characters}

## 完整属性系统
{attribute_system}

## 全局叙事架构
{architecture}

# 生成要求

## 优先级说明
- **最高优先级**：本章定位中的【章节大纲】。如果大纲内容与前文摘要、属性系统或其他设定有冲突，请**严格以章节大纲为准**进行剧情生成。

## 内容规范
- 叙事视角：主要使用第二人称（"你"）
- 字数范围：2000字左右
- 选择点数量：1-2个，自然分布在章节中
- 沉浸感：通过对话场景、动作场景、心里场景和环境描写等增强玩家代入感

## 选择点嵌入规范
选择点必须严格以下列格式嵌入在剧情中（属性影响四个字后面加属性名和值，属性名必须在属性系统之内）：
这里是前文剧情，引出玩家选择（选项在下一行）...
→ A. [选项描述] [属性影响：属性名±值]
[选择后的立即反应，2-3句话]
→ B. [选项描述] [属性影响：属性名±值]
[选择后的立即反应，2-3句话]
这里是后面的主线剧情，主线剧情与选项无关，请忽略玩家选择，自然过渡到下一个场景...

## 选择点设计规则
1. 该选择是否重大仅体现在对属性值的影响上，选择越重大，对属性值影响越大
2. 结局之前的主线剧情始终是线性的，不会因为玩家选择而影响主线剧情，确保每一个选择能在3句话内回归主线
3. 选择点必须出现在自然的对话或决策情境后，选项要体现角色性格和处境
4. 选择后的反应：2-3句话展示立即后果，然后自然回归主线
5. 确保选择点自然融入剧情，不要让玩家感觉选项是突兀插入的。

## 对话设计规范
- 对话要符合角色性格设定
- 通过对话自然引出决策点
- 对话中要体现角色关系和情感变化
- 避免冗长的独白，保持对话的互动性

# 输出格式
请严格按照以下格式输出：
第{chapter_index}章 - [章节标题]

### 剧情内容
[完整的叙事内容，包含嵌入的选择点]

"""

def build_last_chapter_with_endings_prompt(
    chapter_index: int,
    chapter_directory: str, 
    attribute_system: str,
    characters: str, 
    architecture: str,
    previous_chapter_content: str = None,  
    global_summary: str = None  # 累积的全局摘要
) -> str:
    chapter_info = extract_chapter_from_directory(chapter_directory, chapter_index)

    return f"""
# 任务概述
你正在创作文字冒险游戏的第 {chapter_index} 章（最终章），需要一次性完成两个部分：
1. 生成这一章的前半部分剧情（为多结局做铺垫，但不要实际展开结局）
2. 基于整个游戏内容设计3-4个不同的结局概述（根据属性系统判定）

{f'## 前文摘要\n{global_summary}\n' if global_summary else ''}
{f'## 前一章结尾\n{previous_chapter_content[-500:]}\n' if previous_chapter_content else ''}

## 本章定位
{chapter_info}

# 上下文信息

## 主要角色设定
{characters}

## 完整属性系统
{attribute_system}

## 全局叙事架构
{architecture}

# 生成要求

## 第一部分：最终章前半部分

### 内容规范
- **只生成这一章的前半部分**：剧情发展到即将进入结局的关键时刻就停止
- **不要生成任何结局内容**：结局将在第二部分概述
- **叙事视角**：主要使用第二人称（"你"）
- **字数范围**：1000-1500字（仅前半部分）
- **选择点数量**：0或1个，如果有，请安排在结局之前，进入结局时不再有选项
- **沉浸感**：通过对话场景、动作场景、心理描写和环境描写等增强玩家代入感

### 情感氛围
- 最后一章旨在根据玩家前面章节的选择判定结局，情感定位上并非重大选择时刻，而是揭示结局时刻，应水到渠成、自然过渡

### 选择点嵌入规范（如果有选择点）
选择点必须严格以下列格式嵌入在剧情中（选择点必须出现在自然的对话或决策情境后，属性影响四个字后面加属性名和值，属性名必须严格在属性系统之内）：
这里是前文剧情，引出玩家选择...
→ A. [选项描述] [影响属性：属性名±值]
[选择后的立即反应，2-3句话，不影响主线剧情]
→ B. [选项描述] [影响属性：属性名±值]
[选择后的立即反应，2-3句话，不影响主线剧情]
这里是后面的主线剧情，主线剧情与选项无关，请自然过渡，不要提选项相关的事，忽略玩家选择...

### 停止时机
- 当剧情发展到**结局触发点**时立即停止
- 结局触发点示例：真相揭示前、最终对决前等
- 不要描述任何结局结果，只需将玩家自然带到结局的门槛
- 确保所有结局都能自然地停止点展开

## 第二部分：结局概述设计

### 设计要求
1. **结局多样性**：设计3-4个结局，例如：
   - **完美结局**（高难度，属性要求高，圆满）
   - **普通结局**（中等难度，有得有失）
   - **缺憾/特殊结局**（特定属性偏科或较低，带有悲剧色彩或另类展开）
2. **判定逻辑**：基于【完整属性系统】中的属性设定合理的触发条件，条件只能为较高、中等或较低三个词中的一个。
   - 例如："勇气较高，智慧中等" 或 "心计较低"，注意用逗号分隔多个属性条件。严格遵循此格式。
   - 最后一个结局必须为默认结局，属性要求一栏为空。
3. **结局简述**：为每个结局提供150-200字左右的剧情梗概。

# 输出格式
请严格按照以下格式输出，不要解释任何内容：
第{chapter_index}章 - [章节标题]

#### 剧情内容
[仅包含前半部分的叙事内容，在结局触发点停止]

## 结局概述

### 结局1
**标题**：xxx
**属性要求**：勇气较高，智慧中等
**剧情概述**：[150-200字的剧情梗概]

### 结局2
**标题**：xxx
**属性要求**：心计较低
**剧情概述**：[150-200字的剧情梗概]

### 结局3
格式同上

[如果有其他结局，继续添加...]
"""

def build_ending_content_prompt(
    ending_title: str,
    ending_condition: str,
    ending_summary: str,
    chapter_index: int,
    architecture: str,
    attribute_system: str,
    characters: str,
    global_summary: str,
    previous_chapter_content: str, # 倒数第二章
    last_chapter_content: str # 最后一章前半部分
) -> str:
    return f"""
# 任务
你正在撰写文字冒险游戏剧情的最终章（第{chapter_index}章）。
这是一个特定的结局分支：{ending_title}。

# 触发条件
{ending_condition}

# 结局梗概
{ending_summary}

# 上下文信息

## 全局剧情摘要
{global_summary}

## 结局前提内容
{previous_chapter_content[-500:] if previous_chapter_content else ""}
{last_chapter_content}

## 完整属性系统
{attribute_system}

## 角色设定
{characters}

## 完整叙事架构
{architecture}

# 生成要求
1. **完整叙事**：紧跟【结局前提内容】，把【结局梗概】扩写成完整的结局（1500字左右）。
2. **情感收束**：回收之前的伏笔，对核心角色的命运给出交代。
3. **代入感**：使用第二人称“你”。
4. **无需选择点**：这是结局章节，不再包含新的分支选择。

# 输出格式
请直接输出扩写后的【结局梗概】，确保与【结局前提内容】自然衔接，不要有突兀的跳跃，不要任何解释。
"""

def update_summary_prompt(
    global_summary: str,
    new_chapter: str
) -> str:
    return f"""
# 任务
你是一位资深的文字冒险游戏剧情策划。请根据现有的前文摘要和最新一章的剧情更新摘要。

# 以下是新完成的章节文本：
{new_chapter}

# 以下是前文摘要（为空则说明现在是第一章）：
{global_summary}

# 要求：
- 保留既有重要信息，同时融入新剧情要点。
- 以简洁、连贯的语言描述剧情进展，仅关注剧情发展，忽略文本中给出的选项。
- 客观描绘，不展开联想或解释。
- 总字数控制在1000字以内。

仅返回更新后的前文摘要文本，不要解释任何内容。
"""

def build_cover_image_prompt_prompt(core_seed: str) -> str:
    """AI辅助构建生成作品封面的prompt
    """
    return f"""
# 角色
你是一位经验丰富的AI绘画提示词（Prompt）工程师，专精于将小说设定转化为高质量、高表现力、完整、全面的图像生成Prompt。

# 任务
你将收到一段小说（文字冒险游戏）的核心设定。你的任务是分析这段设定，并生成一个结构完整、细节丰富的图像生成Prompt，用于绘制这本小说的封面。

# 核心设定
{core_seed}

---

# Prompt生成指南

请严格按照以下结构，生成一个完整的、可以直接用于AI绘画工具的Prompt。你需要根据【核心设定】的内容，进行合理的推断和艺术化加工，填充到各个模块中。

## 1. 核心主题与氛围
- **一句话总结**：用一句话概括画面的核心主题和要传达的情绪。
- **关键词**：列出3-5个最能代表故事氛围的关键词（例如：史诗、神秘、浪漫、赛博朋克、复古、恐怖、希望）。

## 2. 画面主体与构图
- **主体**：明确画面的中心是谁或什么。描述主角/核心元素的外观、姿态、表情。
- **构图**：选择一个合适的构图方式（例如：中心构图、黄金分割、特写、远景），并描述视角（例如：仰视、俯视、平视）。

## 3. 环境与背景
- **场景**：描述主角所处的具体环境，包括建筑、自然景观等。
- **关键元素**：列出背景中必须出现的、与故事紧密相关的物品或符号（例如：一把剑、一朵奇特的花、一座漂浮的城堡）。

## 4. 艺术风格与媒介
- **风格**：选择一种最匹配的艺术风格（例如：日系动漫风、写实主义、水彩、油画、像素艺术、暗黑艺术）。
- **参考**：可以提及1-2位艺术家或风格作为参考（例如：风格类似宫崎骏，或类似《赛博朋克2077》的美术风格）。

## 5. 色彩与光影
- **色彩方案**：描述主色调和点缀色，以及它们如何营造氛围（例如：以冷色调为主，用暖色高光点缀）。
- **光影效果**：描述光线的来源和质感（例如：柔和的晨光、戏剧性的伦勃朗光、霓虹灯的冷光）。

## 6. 技术与质量词
- **技术参数**：添加通用的提升画质的关键词（例如：杰作, 最佳质量, 8k, 超精细细节, 复杂细节, 电影光效）。
- **画面比例**：默认使用 16:9。

# 最终输出要求
- 严格按照以上格式输出。
- 不要包含任何解释性文字，只输出最终的Prompt。
- 确保Prompt逻辑清晰，重点突出。
"""

def build_scene_image_prompt_prompt(chapter_content: str) -> str:
    """AI辅助构建生成场景画面的prompt
    """
    return f"""
# 角色
你是一位经验丰富的AI绘画提示词（Prompt）工程师，专精于将小说剧情转化为高质量、高表现力、完整、全面的图像生成Prompt。

# 任务
你将收到一段小说（文字冒险游戏）剧情的某一章节内容。你的任务是分析这段内容，将其按顺序合理切分为一个或多个画面单元（最少一个，最多三个），
并生成一个结构完整、细节丰富的图像生成Prompt，用于绘制场景背景图片。

# 章节剧情
{chapter_content}

# prompt生成指南
请严格按照以下结构，为每个画面单元生成一个完整的、可以直接用于AI绘画工具的Prompt。你需要根据【章节剧情】的内容，进行合理的推断和艺术化加工，填充到各个模块中。

## 画面1：

### 范围：[结束百分比]

### 核心主题与氛围
- 一句话总结：用一句话概括画面核心主题和人物要传达的情绪状态。
- 关键词：列出3-5个最能代表人物状态和故事氛围的关键词（例如：人物状态：孤独、坚毅、沉思、觉醒、忧郁；故事氛围：史诗、神秘、浪漫、赛博朋克、复古、恐怖、希望）。

### 画面主体与构图
- 人物主体：详细描述中心人物的外观特征、服装、姿态、面部表情和眼神。
- 构图方式：选择突出人物的构图（例如：人物中心构图、黄金分割构图、七分身像、面部特写、全身像）
- 视角选择：明确观察角度（例如：平视建立亲切感、仰视增强气势、俯视营造距离感）

### 环境与背景
- 场景设置：描述人物所处的具体环境，环境要与人物状态相呼应
- 场景元素：列出人物正在接触或与之互动的物品（例如：手持的武器、倚靠的墙壁、凝视的物品）以及背景中必须出现的、与故事紧密相关的物品或符号（例如：一把剑、一朵奇特的花、一座漂浮的城堡）

### 艺术风格与媒介
- 风格：选择最适合表现人物情感的艺术风格（例如：写实肖像、日系角色设计、古典油画、现代插画）。
- 参考：可以提及1-2位艺术家或风格作为参考（例如：风格类似宫崎骏，或类似《赛博朋克2077》的美术风格）。

### 色彩与光影
- 人物用色：描述人物服装、肤色的主色调，以及如何通过色彩突出人物
- 光影处理：重点描述人物身上的光影效果（例如：伦勃朗光突出面部轮廓、逆光营造神秘感、柔和光表现温柔）

### 技术与质量词
- 人物细节：添加强调人物细节的关键词（例如：精致五官、细腻皮肤纹理、服装褶皱细节、眼神光）
- 通用质量：杰作、最佳质量、8k、超精细细节、电影级光效
- 画面比例：16:9

## 画面2：

### 范围：[结束百分比]
（结构同上）

如果还有画面请继续...

# 特别注意
- 范围指的是百分数占比（但不带百分号），例如画面1范围是70即代表从开头持续到本章剧情字数的70%，画面2范围是100即代表从本章内容的70%持续到100%
- 最后一个画面的范围必须是100。
- 每个画面都要保持连贯性和逻辑顺序。
- 根据剧情的场景变化合理划分画面单元。
- 画面单元最少为 1 个，最多为 3 个。
- 忽略剧情文本中的选项相关信息（如果存在的话）。
- 确保每个Prompt都能独立生成高质量的背景图像。
- 直接按要求返回有效格式，不要任何解释。
"""

def build_report_prompt(
    global_summary: str,
    ending_summary: str,
    ending_title: str
) -> str:
    return f"""
# 任务
你是一位资深的文字冒险游戏剧情策划。请根据以下提供的全局剧情摘要和玩家达成的结局，生成详细的玩家个性报告。

# 全局剧情摘要
{global_summary}

# 达成结局
标题：{ending_title}
概述：{ending_summary}

# 报告要求
请生成一份个性化的结算报告，包含以下内容：
1. **称号**：一个四字或五字的独特称号，概括玩家在故事中的表现（如“宫心计谋家”、“末世独行者”）。
2. **评价**：一段100-150字的评价，以第二人称“你”的口吻，分析玩家的性格特点、决策风格以及在故事中的命运。
3. **特质**：提取3-4个关键词标签，描述玩家的核心特质（如“果敢”、“深谋远虑”、“仁慈”）。

# 输出格式
请严格按照以下格式输出，不要包含任何解释：
[称号]：xxxx
[评价]：xxxx
[特质]：xxxx, xxxx, xxxx
"""

