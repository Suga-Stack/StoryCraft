import re
def build_story_seed_prompt(
    tags: list[str],
    idea: str,
    total_chapters: int
) -> str:
    """故事种子生成"""

    categorized_tags = extract_tag_categories(tags)
    category_text = ""
    for category, tag_list in categorized_tags.items():
        if tag_list:
            category_text += f"- **{category}标签**: {', '.join(tag_list)}\n"
    
    return f"""
# 任务总览

你是一位资深故事架构师。你的任务是根据用户输入的标签，**理解用户喜好背后的情感需求**，创造一个有生命力的故事。这个故事将服务于一款文字冒险游戏。

## 用户输入
- **故事标签（代表用户偏好）**: {', '.join(tags)}
- **额外想法**: {idea if idea else "无，完全由你发挥"}
- **期望长度**: {total_chapters}章
- **目标**: 第二人称沉浸式文字冒险游戏剧情

## 标签分析
{category_text}

## 第一步：理解标签背后的情感需求
请不要直接使用标签字面意思，而是思考：
1. **当用户选择这些标签时，他们期待什么体验？**
   - 放松娱乐？紧张刺激？情感共鸣？成就感？探索感？
   - 这些标签组合可能暗示什么独特的复合体验？

2. **如何创造性融合这些标签？**
   - 哪些标签是核心体验，哪些是氛围调味？
   - 如果存在冲突标签，如何转化为独特魅力？

3. **如何用一句话打动这类标签的爱好者？**

## 第二步：发现故事的本质核心

### 请先回答这些根本问题：
1. **这个故事最打动人的是什么？**
   - 是宏大的冒险？细腻的情感？精巧的谜题？独特的氛围？
   - 一句话说：玩家为什么会沉浸其中？

2. **主角的核心吸引力是什么？**
   - 是不屈的意志？独特的视角？有趣的性格？特别的处境？
   - 玩家想要成为什么样的"自己"？

3. **这个故事想要探讨什么？**
   - 一个主题？一个问题？一种感受？一段经历？

## 第三步：生成故事DNA

基于你的思考，请创作：

### 【灵魂一问】
整个故事围绕的核心问题（开放式，引人深思）

### 【一句话魅力】
15字内，让人立即产生兴趣的描述

### 【情感体验】
玩家将体验到的核心情感旅程（考虑标签冲突可能带来的独特情感混合）

### 【主角起点】
- 身份/处境：开始时"你"是谁，在做什么
- 独特之处：你与众不同的地方
- 初始目标：你现在最想要什么

### 【世界一瞥】
150字内，最有特色的世界观设定（如何融合标签中的世界观元素？）

### 【潜在冲突/动力】（根据故事本质决定）
如果这是一个以对抗为核心的故事：
- 主要对立力量：
- 冲突的本质：

如果这是一个以成长/探索为核心的故事：
- 成长的核心挑战：
- 探索的主要方向：

如果这是一个以关系为核心的故事：
- 核心关系网络：
- 关系的发展方向：

如果这是一个其他类型核心的故事：
- 请自行想象

**特别考虑**：如果标签有冲突，冲突可能体现在故事的这个部分吗？

### 【章节节奏感】
基于{total_chapters}章和故事本质，你觉得：
- **最适合的情感曲线**是什么形状？
- **最关键的转折点**应该在哪里？
- **情感高潮**应该如何分布？

## 第四步：为数值系统设计提供思考基础

### 【成长维度思考】
在这个故事中，玩家可能会：
1. **学会/提升什么技能？**（解决什么类型的问题）
2. **建立/深化什么关系？**（与谁的情感连接）  
3. **获得/改变什么特质？**（内心的成长）
4. **积累/管理什么资源？**（独特的数值维度）

### 【选择空间想象】
在这个世界中，玩家最可能面临：
1. **什么类型的道德/伦理选择？**
2. **什么类型的策略/资源选择？**
3. **什么类型的关系/情感选择？**
4. **什么类型的技能/能力选择？**

### 【数值系统建议】
基于以上，请设计数值系统的核心维度：
1. **必须包含数值系统**：哪些3-5个维度最适合量化这个故事的核心体验？
2. **维度类型建议**：
   - 哪些维度应该是核心能力（如智力、力量等）？
   - 哪些维度应该是关系/好感度（针对特定角色）？
   - 哪些维度应该是特殊机制（如san值、建设度等）？
3. **数值关联**：这些维度如何与玩家的选择自然关联？

## 第五步：完整输出，请严格按照以下格式输出，不要任何解释：
[灵魂一问]：
[一句话魅力]：
[情感体验]：
[主角起点]：
- 身份/处境：
- 独特之处：
- 初始目标：
[世界一瞥]：
[潜在冲突/动力]：
[成长维度思考]：
[选择空间想象]：
[数值系统建议]：
- 维度1：[名称]（[类型]）- [作用简述]
- 维度2：[名称]（[类型]）- [作用简述]
- 维度3：[名称]（[类型]）- [作用简述]
- 维度4：[名称]（[类型]）- [作用简述]
- 维度5：[名称]（[类型]）- [作用简述]（可选）
[章节节奏分布]:
[创作手法选择]：
- 创意方向：[具体方向]
- 情感营造：[具体手法]
- 标签冲突处理: [如有冲突，可选]
- 其他特色：[可选]

## 创作原则
1. **深度优先**：先找到故事的灵魂，再考虑标签
2. **标签融合**：即使标签冲突，也要创造性地融合它们
3. **数值必需**：必须设计可量化的数值维度系统
4. **情感真实**：确保故事有真实的情感基础
5. **玩家中心**：始终思考玩家会如何体验

## 附录：创作工具库（供参考）

### 1. 标签冲突处理手法
当标签看似矛盾时，可考虑以下融合策略：

**A. 反差融合法**
- **错位反差**：将矛盾特质赋予同一角色/场景（如：温柔的杀手、欢快的葬礼）
- **氛围反差**：用轻松笔调写沉重主题，或用严肃氛围写轻松故事
- **视角反差**：不同角色对同一事件有完全相反的解读

**B. 阶段转换法**
- **渐进转变**：故事基调逐渐从A转向B（如：从轻松日常到紧张悬疑）
- **情境切换**：不同章节侧重不同标签风格
- **双线并行**：主线与支线采用不同风格

**C. 主题升华法**
- **表层与内核**：表面是A，内核是B（如：表面是甜宠，内核是成长）
- **解构重组**：对传统标签进行创新性解读
- **多维呈现**：通过多角色展现不同标签特质

### 2. 创意方向参考

**世界观创新角度**
- **规则异常**：世界规则出现异常或漏洞
- **文化碰撞**：不同世界观元素意外融合
- **科技魔法**：科技与魔法/超能力的独特结合
- **时间悖论**：时间相关的特殊设定
- **身份谜团**：主角身份存在不为人知的秘密

**主角设计角度**
- **非典型英雄**：拥有非传统英雄特质的主角
- **迟来觉醒**：在关键事件后才意识到自身特殊
- **被迫成长**：环境逼迫下不得不成长
- **双重身份**：公开身份与隐秘身份的矛盾
- **反向目标**：目标与表面意图相反

**叙事结构角度**
- **倒叙揭秘**：从结果开始，逐步揭示过程
- **多线交织**：多条故事线并行发展
- **循环嵌套**：故事中存在循环或嵌套结构
- **视角切换**：不同章节切换不同视角
- **元叙事**：角色意识到自己处于故事中

### 3. 情感营造手法

**情感节奏控制**
- **情感铺垫**：通过细节积累情感能量
- **情感爆发**：在合适节点释放情感张力
- **情感回落**：高潮后的平静与反思
- **情感余韵**：结局后的回味空间

**沉浸感增强**
- **感官描写**：强化视觉、听觉、触觉等感官体验
- **内心独白**：深入展现主角内心活动
- **环境互动**：环境对角色情感产生反馈
- **细节真实**：通过真实细节增强代入感

**角色关系构建**
- **共同经历**：通过共同经历建立情感连接
- **价值冲突**：角色间价值观的碰撞与磨合
- **秘密共享**：共享秘密深化关系
- **牺牲考验**：通过牺牲考验关系深度
"""

def build_detailed_framework_prompt(
    story_seed: str,
    total_chapters: int
) -> str:
    """基于故事种子构建详细框架"""
    
    # 尝试提取创作手法
    techniques_pattern = r'\[创作手法选择\]：(.*?)(?=\n##|\Z)'
    techniques_match = re.search(techniques_pattern, story_seed, re.DOTALL)
    
    techniques_text = ""
    if techniques_match:
        techniques_text = techniques_match.group(1).strip()
        techniques_text = f"## 创作手法参考\n{techniques_text}\n"
    
    # 尝试提取数值系统建议
    attributes_pattern = r'\[数值系统建议\]：(.*?)(?=\n\[创作手法选择\]|\Z)'
    attributes_match = re.search(attributes_pattern, story_seed, re.DOTALL)
    
    attributes_text = ""
    if attributes_match:
        attributes_text = attributes_match.group(1).strip()
    
    return f"""
# 故事框架构建师：从DNA到可执行框架

你是一位专业的游戏系统设计师和叙事架构师。你的任务是将第一步生成的故事DNA转化为**可执行的具体框架**，包括详细的属性系统、角色设定和叙事结构。

## 第一步生成的故事DNA
{story_seed}

{techniques_text}

## 框架构建任务

### 1. 属性系统详细设计
基于第一步的【数值系统建议】，设计完整的属性系统：

#### 属性维度定义（设计3-5个维度）
每个维度必须包含：
- **属性名称**：[名称]
- **属性类型**：[核心能力/关系好感/特殊机制]
- **初始值**：20-50之间的具体数值（关系类可设为0-30）
- **数值范围**：0-100
- **核心作用**：在游戏中具体影响什么？
- **成长规则**：如何提升？提升后具体效果？
- **关键应用场景**：在哪些情境下会用到此属性？

#### 属性平衡设计
- **初始总值**：所有属性初始值总和建议在100-150点之间
- **协同效应**：属性之间如何相互影响？
- **制约关系**：是否存在属性间的制约或冲突？

#### 选择影响量化
设计选择对属性影响的标准：
- **普通选择**：±2-5点
- **重要选择**：±6-10点  
- **关键选择**：±11-20点

### 2. 角色详细设定
基于第一步的【主角起点】和【潜在冲突/动力】，设计3-4个核心角色：

#### 主角详细设定
- **完整名称**：[姓名]
- **外貌特征**：[简洁描述]
- **性格特点**：[3-4个关键词]
- **背景故事**：[与世界观相关的50字内背景]
- **成长潜力**：在故事中可能如何成长变化？
- **内在矛盾**：[如果有标签冲突，体现于此]

#### 核心角色设计（设计2-3个）
每个角色包含：
- **角色名称**：[姓名]
- **身份标签**：[如：神秘导师、竞争对手、可靠盟友]
- **外貌特征**：[简洁但有特色]
- **性格核心**：[最鲜明的性格特质]
- **与主角关系**：初始关系 + 可发展方向
- **背景关联**：与世界观或主线的关联
- **角色弧光**：在故事中可能经历的变化
- **关键选择点**：在哪些时刻会影响玩家的选择

#### 角色关系网络
- **角色间关系**：简单的冲突或合作网络
- **情感权重分配**：哪个角色承载最重要的情感体验
- **对话风格指引**：每个角色的独特对话风格

### 3. 叙事框架详细设计
基于{total_chapters}章和第一步的【章节节奏感】，设计详细的叙事框架：

#### 整体叙事曲线
- **情感起点**：故事开始时的情感状态
- **关键转折点**：至少设计2个重要转折点（在第几章）
- **情感高峰**：情感最强烈的时刻（在第几章）
- **结局回落**：结局时的情感状态
- **节奏控制**：如何控制章节间的节奏变化？

#### 阶段详细规划
请根据{total_chapters}章设计合理的阶段划分（3-5个阶段），每个阶段包含：

**阶段一：[阶段名称]（第1-[X]章）**
- **核心目标**：此阶段要达成的叙事目标
- **情感基调**：主要的情感氛围
- **关键事件**：此阶段发生的重要事件
- **属性聚焦**：重点展示哪些属性
- **角色发展**：重点发展哪些角色关系
- **选择设计**：此阶段重要的选择类型
- **伏笔埋设**：为后续阶段埋设的伏笔

**阶段二：[阶段名称]（第[X+1]-[Y]章）**
...（根据阶段数量继续）

#### 结局系统设计
基于多结局需求，设计：
- **结局数量**：建议3-4个不同结局
- **结局类型**：完美结局、普通结局、遗憾结局、隐藏结局等
- **触发条件**：基于属性值的具体触发条件（如：属性A>70且属性B>60）
- **结局差异化**：不同结局的核心差异点

### 4. 选择系统设计
基于第一步的【选择空间想象】，设计：
- **选择类型分类**：至少3种不同类型的选择
- **选择权重分配**：不同类型选择在游戏中的分布
- **选择后果设计**：选择如何影响属性和剧情（注意：选择不影响主线，仅影响属性）
- **选择回响机制**：早期选择如何在后期产生回响

## 输出格式

请严格按照以下格式输出，不要任何解释：

### 属性系统详细设计

#### 维度1：[属性名称]（[属性类型]）
- 初始值：[数值]
- 数值范围：0-100
- 核心作用：[详细说明]
- 成长规则：[如何提升，提升效果]
- 关键应用场景：[具体场景示例]

#### 维度2：[属性名称]（[属性类型]）
...（继续其他维度）

**属性平衡说明**：[说明初始总值、协同效应、制约关系等]

### 角色详细设定

#### 主角：[角色名称]
- 外貌特征：
- 性格特点：
- 背景故事：
- 成长潜力：
- 内在矛盾：

#### 核心角色1：[角色名称] - [身份标签]
- 外貌特征：
- 性格核心：
- 与主角关系：
- 背景关联：
- 角色弧光：
- 关键选择点：

#### 核心角色2：[角色名称] - [身份标签]
...（继续其他角色）

**角色关系网络**：[简要说明角色间的关系网络和情感权重分配]

### 叙事框架详细设计

#### 整体叙事曲线
- 情感起点：
- 关键转折点1（第X章）：
- 关键转折点2（第Y章）：
- 情感高峰（第Z章）：
- 结局回落：
- 节奏控制策略：

#### 阶段规划（共{total_chapters}章）

**阶段一：[阶段名称]（第1-[X]章）**
- 核心目标：
- 情感基调：
- 关键事件：
- 属性聚焦：
- 角色发展：
- 选择设计：
- 伏笔埋设：

**阶段二：[阶段名称]（第[X+1]-[Y]章）**
...（根据实际阶段数量继续）

#### 结局系统设计
- 结局数量：[数字]个
- 结局类型及触发条件：
  1. [结局类型]：[属性条件]
  2. [结局类型]：[属性条件]
  3. [结局类型]：[属性条件]
- 结局差异化说明：

### 选择系统设计
- 选择类型分类：
  1. [类型名称]：[描述]（占比约X%）
  2. [类型名称]：[描述]（占比约X%）
  3. [类型名称]：[描述]（占比约X%）
- 选择权重分配：
- 选择后果设计：
- 选择回响机制：

## 创作原则
1. **一致性**：所有设计必须与第一步的故事DNA保持一致
2. **可执行性**：生成的框架要能够直接用于后续的章节目录生成
3. **玩家体验**：始终考虑玩家的选择和体验
4. **平衡性**：属性系统要平衡，叙事节奏要合理
5. **创新性**：在遵循第一步创意的基础上，进行合理的扩展和创新

现在，请基于第一步的故事DNA，开始构建详细框架。
"""



def extract_tag_categories(tags: list[str]) -> dict:
    """提取和分类标签的辅助函数"""
    tag_categories = {
        "故事类型": [
            "玄幻", "奇幻", "仙侠", "武侠", "科幻", "都市", "历史", "军事", 
            "悬疑", "灵异", "惊悚", "游戏", "竞技", "体育", "言情", "现实"
        ],
        "故事风格": [
            "升级流", "无敌流", "重生", "穿越", "系统", "无限流", "种田", "基建", 
            "末世", "废土", "爽文", "轻松", "搞笑", "治愈", "暗黑", "虐心", 
            "烧脑", "智斗", "群像", "日常", "生活流", "热血", "争霸", "权谋", 
            "扮猪吃虎", "腹黑", "忠犬", "傲娇", "病娇", "萌宝", "马甲", "神豪", "赘婿"
        ],
        "世界观": [
            "现代", "古代", "异界", "异世界", "星际", "未来", "民国", "原始社会", 
            "原始部落", "洪荒", "高武", "西幻", "克鲁苏", "赛博朋克", "蒸汽朋克"
        ],
        "题材": [
            "男频", "女频", "甜宠", "霸总", "女强", "女尊", "宫斗", "宅斗", 
            "职场", "职场商战", "校园", "青春", "耽美", "百合", "明星同人", "二次元", 
            "轻小说", "影视改编"
        ]
    }
    
    categorized = {category: [] for category in tag_categories}
    
    for tag in tags:
        matched = False
        for category, category_tags in tag_categories.items():
            if tag in category_tags:
                categorized[category].append(tag)
                matched = True
                break
        if not matched:
            # 如果标签不在任何分类中，默认放入"题材"
            categorized["题材"].append(tag)
    
    # 检查空分类并填充默认值
    for category in categorized:
        if not categorized[category]:
            categorized[category] = ["请自行判断"]
    
    return categorized

def build_smart_core_seed_prompt(
    tags: list[str],
    idea: str,
    total_chapters: int
) -> str:
    """核心种子生成（包含角色、属性、完整章节蓝图）"""
    
    # 分析标签
    categorized_tags = extract_tag_categories(tags)
    category_text = ""
    for category, tag_list in categorized_tags.items():
        if tag_list:
            category_text += f"- **{category}标签**: {', '.join(tag_list)}\n"
    
    # 构建阶段描述文本
    stage_text = "## 章节蓝图（叙事框架）\n"
    stage_text += f"总章数：{total_chapters}章\n\n"
    

    # 属性系统设计指导
    attribute_guidance = {
        "traditional": """
**属性系统设计建议**：采用传统能力属性系统
- 设计3-5个核心能力属性（如智力、力量、魅力、感知等）
- 属性值范围：0-100，初始值建议在20-50之间
- 属性影响剧情选择、挑战结果、谜题解决等
- 属性间可以有协同效应，但要避免重复功能
""",
        "relationship": """
**属性系统设计建议**：以关系/好感度为核心的系统
- 设计2-4个核心角色的好感度属性（如"林晓好感度"、"陈学长好感度"等）
- 可搭配1-2个个人特质属性（如魅力、情商、判断力等）
- 好感度值范围：-50到100，初始值建议在0-30之间
- 好感度影响剧情走向、角色互动选项和结局
""",
        "hybrid": """
**属性系统设计建议**：混合系统（能力+关系）
- 设计2-3个能力属性（如智力、体力、专业能力等）
- 设计2-3个关系属性（如特定角色好感度、团队信任度等）
- 总值平衡，避免单一属性过于强势
- 确保不同属性在不同阶段都有应用场景
""",
        "special": """
**属性系统设计建议**：特殊机制属性
- 设计3-5个与世界观紧密相关的独特属性（如生存值、理智值、建设度、科技点等）
- 属性之间功能不重叠，每个都有独特作用
- 考虑属性的相互影响（如某些属性降低会导致其他属性变化）
- 属性值与游戏机制深度绑定
"""
    }
    
    # 判断是否需要强烈冲突
    conflict_needed = any(tag in ["悬疑", "惊悚", "权谋", "争霸", "热血", "灵异"] for tag in tags)

    return f"""
# 故事基因工程：核心种子生成

你是一位资深的故事架构师，擅长将不同的标签融合成独特的故事DNA。

## 输入参数
- **标签组合（代表用户偏好）**: {', '.join(tags)}
- **创意方向**: {idea if idea else "无特定构思，请根据标签自由发挥"}
- **章节规划**: {total_chapters}章
- **目标**: 第二人称沉浸式文字冒险游戏

## 标签分析

### 1. 标签分类
{category_text}

### 2. 用户需求分析
不要直接使用标签字面意思，而是思考：
- 当用户选择这些标签时，他们期待什么体验？放松娱乐？紧张刺激？情感共鸣？成就感？探索感？社交感？
- 哪些标签是核心体验，哪些是氛围偏好？例："玄幻"是世界观，"轻松"是氛围，"系统"是机制
- 如何用一句话打动这类标签的爱好者？

### 3. 故事本质分析
请先回答这些根本问题：
- 这个故事最打动人的是什么？是宏大的冒险？细腻的情感？精巧的谜题？一句话说：玩家为什么会沉浸其中？
- 主角的核心吸引力是什么？是不屈的意志？独特的视角？有趣的性格？玩家想要成为什么样的"自己"？
- 这个故事想要探讨什么？一个主题？一个问题？一种感受？

### 3. 冲突转化策略（如存在冲突）
如果标签间存在风格冲突，请选择以下策略之一进行创造性融合：
- **反差魅力法**: 用轻松笔调写黑暗内核，或用严肃氛围写轻松故事
- **双线并行法**: 不同章节侧重不同标签风格
- **渐进转变法**: 故事基调逐渐从A转向B
- **多重视角法**: 不同角色体现不同标签特质

### 4. 创意催化剂
可从以下角度中选择一个作为故事的核心创意点（仅供参考，也可自行创新）：
1. **非典型英雄**: 主角拥有不典型的"英雄"特质
2. **规则漏洞**: 世界规则存在可利用的漏洞
3. **错误认知**: 主角对世界的认知从开始就是错的
4. **双重困境**: 面临两个同等重要但冲突的目标
5. **传承诅咒**: 继承的东西既是祝福也是诅咒
6. **身份错配**: 主角身处完全不适合的身份中
7. **迟来的觉醒**: 在关键事件后才意识到自己的特殊
8. **有限的选择**: 所有选项都有明显的代价
9. **隐藏的连接**: 看似无关的事件存在深层联系
10. **反向成长**: 力量增长伴随着某种失去

## 核心种子生成

### 【世界观设定】（150字内）
包括：时代背景、基本规则、独特设定、社会结构等

### 【故事核心】
- **核心驱动力**: {f'用一句话概括故事的核心冲突（对抗性）' if conflict_needed else '用一句话概括故事的核心吸引力（体验性）'}
- **中心问题**: 整个故事围绕的核心疑问（用问句）
- **情感基调**: 主要的情感体验方向

### 【主角设定】
- **初始身份**: 
- **基本处境**: 
- **核心特质/限制**: 
- **初始目标**: 

### 【角色关系草图】（设计3-4个核心角色）
每个角色包含：
- **角色名称/代号**: 
- **角色类型**: 如导师、盟友、对手、恋人、亲人等
- **与主角关系**: 初始关系+发展可能性
- **情感重要性**: 在故事中的情感权重（高/中/低）
- **独特之处**: 角色的一个显著特点

### 【属性系统框架】


请根据建议设计3-5个属性维度，维度之间功能不重叠，每个维度包含：
- **属性名称**: 
- **属性类型**: [能力/关系/特殊] 
- **核心作用**: 在故事中影响什么方面的决策或结果
- **成长意义**: 提升后对剧情和体验的影响
- **初始值**: 建议范围20-50（关系类可为0-30，特殊类根据设定调整）
- **关键应用场景**: 在哪些典型情境下会用到此属性

{stage_text}

### 【标题】
为剧情想一个好的标题（10字以内，有吸引力）

### 【简介】（150字内）
一段简短、引人入胜的简介，制造悬念但不剧透关键转折

## 输出格式（请严格按照以下格式输出，不要任何解释）：
[世界观设定]: 
[核心驱动力]: 
[中心问题]: 
[情感基调]: 
[主角设定]:
- 初始身份:
- 基本处境: 
- 核心特质/限制:
- 初始目标:
[角色关系草图]:
1. [角色名称/代号] - [角色类型]: [与主角关系] | 情感重要性:[高/中/低] | [独特之处]
2. [角色名称/代号] - [角色类型]: [与主角关系] | 情感重要性:[高/中/低] | [独特之处]
3. [角色名称/代号] - [角色类型]: [与主角关系] | 情感重要性:[高/中/低] | [独特之处]
4. 如果有更多请继续...
[属性系统框架]:
1. [属性名称] ([属性类型]): [核心作用] | [成长意义] | 初始值:[数值] | 关键应用场景:[场景]
2. [属性名称] ([属性类型]): [核心作用] | [成长意义] | 初始值:[数值] | 关键应用场景:[场景]
3. [属性名称] ([属性类型]): [核心作用] | [成长意义] | 初始值:[数值] | 关键应用场景:[场景]
4. 如果有更多请继续...

[标题]:
[简介]:

# 创作原则
1. **标签尊重**: 每个标签都要有体现，即使冲突也要找到创意解决方案
2. **独特性**: 相同的标签组合必须产生与前次不同的故事
3. **一致性**: 确保世界观、角色、属性、章节蓝图相互协调
4. **实用性**: 生成的框架要能够直接用于下一步的章节目录生成
5. **平衡性**: 属性系统要平衡，章节蓝图要合理分配情感节奏
"""

def _calculate_narrative_structure(total_chapters: int):
    """根据章节数量计算叙事结构参数"""
    
    # 规模分类
    if total_chapters <= 5:
        scale_type = "短篇体验"
        scale_description = "紧凑叙事，快速情感建立"
    elif total_chapters <= 10:
        scale_type = "中篇故事" 
        scale_description = "平衡发展，完整情感弧线"
    else:
        scale_type = "长篇冒险"
        scale_description = "丰富层次，深度角色发展"
    
    # 阶段划分计算
    if total_chapters <= 3:
        # 超短篇：引入→高潮→收尾
        stage_breakdown = """
【阶段一：快速建立】（第1章）
- 目标：极速建立玩家代入感和核心冲突
- 情感：好奇→投入

【阶段二：集中高潮】（第2章）
- 目标：核心情感爆发和关键选择，为结局铺垫
- 情感：紧张→释放

【阶段三：多结局展开】（第3章）
- 目标：根据玩家属性呈现不同结局分支（3-4个）
- 情感：根据结局变化（满足/遗憾/希望）
"""
    elif total_chapters <= 6:
        stage_breakdown = f"""
【阶段一：建立联结】（第1章）
- 目标：快速建立核心关系和初始目标
- 情感：好奇→初步投入

【阶段二：核心挑战】（{'第2章' if total_chapters == 4 else f'第2-{total_chapters-2}章'}）
- 目标：集中展现主要冲突和属性变化
- 情感：紧张→成长

【阶段三：结局铺垫】（第{total_chapters-1}章）
- 目标：为多结局做情感和逻辑准备
- 情感：期待→紧张

【阶段四：多结局展开】（第{total_chapters}章）
- 目标：根据属性呈现不同结局分支（3-4个）
- 情感：根据结局变化
"""
    elif total_chapters <= 10:
        # 中篇：完整四阶段
        development_end = int(total_chapters * 0.45) # 3或4
        stage_breakdown = f"""
【阶段一：建立联结】（第1章）
- 目标：建立玩家与角色、世界的深度联结
- 情感：好奇→情感投入

【阶段二：挑战成长】（第2-{development_end}章）
- 目标：通过系列挑战促进属性成长
- 情感：紧张→成就感

【阶段三：关系深化】（{'第4章' if total_chapters == 7 else f'第{development_end+1}-{total_chapters-3}章'}）
- 目标：深化角色关系，准备情感高潮
- 情感：复杂→情感累积

【阶段四：结局铺垫】（第{total_chapters-2}-{total_chapters-1}章）
- 目标：多层次情感爆发和重大选择，为多结局做情感和逻辑准备
- 情感：激烈→期待

【阶段五：多结局展开】（第{total_chapters}章）
- 目标：根据玩家属性呈现不同结局分支（3-4个）
- 情感：根据结局变化（满足/遗憾/希望）
"""
    else:
        # 长篇：丰富层次
        development1_end = int(total_chapters * 0.37) # 4或5
        development2_end = int(total_chapters * 0.55)
        stage_breakdown = f"""
【阶段一：世界建立】（第1-2章）
- 目标：深度建立世界观和核心角色关系
- 情感：探索→初步联结

【阶段二：成长挑战】（第3-{development1_end}章）
- 目标：基础属性成长和初步冲突
- 情感：挑战→小成就

【阶段三：关系发展】（第{development1_end+1}-{development2_end}章）
- 目标：深化角色关系和情感复杂度
- 情感：复杂→情感投资

【阶段四：危机累积】（第{development2_end+1}-{total_chapters-3}章）
- 目标：累积紧张感，为高潮做准备
- 情感：压力→期待

【阶段五：结局铺垫】（第{total_chapters-2}-{total_chapters-1}章）
- 目标：多层次情感爆发和重大选择，为结局准备
- 情感：激烈→释放→期待

【阶段六：多结局展开】（第{total_chapters}章）
- 目标：根据玩家属性呈现不同结局分支（3-4个）
- 情感：根据结局变化（满足/希望/反思）
"""
    
    # 规模特异性设计
    scale_specific_design = ""
    if total_chapters <= 3:
        scale_specific_design = "**超短篇设计重点**：\n- 极速情感建立：第一章就要让玩家产生强烈代入感\n- 集中爆发：所有情感权重集中在第2章\n- 情感收束：第3章专注于展示结局"
    elif total_chapters <= 6:
        scale_specific_design = "**短篇设计重点**：\n- 快速但不仓促：在有限章节内完成完整情感弧线\n- 选择精炼：每个选择都要有明确的情感权重\n- 属性聚焦：重点展示2-3个核心属性的成长"
    elif total_chapters <= 10:
        scale_specific_design = "**中篇设计重点**：\n- 平衡发展：确保每个阶段都有足够的情感发展空间\n- 关系深度：有空间发展1-2个深度角色关系\n- 节奏控制：避免前期过于平淡或后期过于仓促"
    else:
        scale_specific_design = "**长篇设计重点**：\n- 层次丰富：可以设计多层次的情感发展和角色弧光\n- 渐进成长：属性成长和关系变化更加细腻"
    
    return {
        "scale_type": scale_type,
        "scale_description": scale_description,
        "stage_breakdown": stage_breakdown,
        "scale_specific_design": scale_specific_design
    }

def build_game_architecture_prompt(
    core_seed: str,
    attribute_system: str,
    characters: str,
    total_chapters: int
) -> str:
    structure = _calculate_narrative_structure(total_chapters)
    return f"""
# 任务总览
你是一位资深的文字冒险游戏编剧，请根据给定的游戏核心设定、角色属性系统、人物设定为{total_chapters}章的文字冒险游戏设计叙事架构。

# 游戏核心设定
{core_seed}

# 属性系统
{attribute_system}

# 人物设定
{characters}

# 章节规模
共{total_chapters}章，{structure["scale_type"]}（{structure["scale_description"]}）

# 叙事曲线
{structure["stage_breakdown"]}

# 规模设计原则
{structure["scale_specific_design"]}

# 架构设计原则
为确保体验完整性：
1. 核心情感弧线：无论章节多少，都要包含"建立→发展→高潮→结局"的完整流程
2. 关键体验保障：确保以下核心体验点得到覆盖：
   - 玩家与至少1个核心角色的深度联结
   - 至少2次有意义的属性成长展示
   - 1个让玩家印象深刻的情感高潮
   - 最后一章进入结局
3. 情感高潮分布：根据章节数量设置一个或多个情感峰值，每个峰值都为最终结局做铺垫
4. 节奏密度控制：章节越少，情感节奏越紧凑；章节越多，情感层次越丰富

# 选择点设计原则
- 每个选择仅会影响属性值，选择越重大，对属性值影响越大
- 选择不会影响最后一章结局之前的主线剧情，仅在最后一章才会根据属性值判定多结局，确保选择后能在3句话内回归主线

# 输出内容
请你糅合以上各种设定，给出一个合理的叙事架构。

# 输出格式要求
请严格按照以下结构和格式输出，输出纯文本，用中文输出，不要输出任何解释：
## 阶段详细规划

### 阶段一：[阶段名称]
**章节范围**：第[起始章]-[结束章]章
**核心目标**：[此阶段要达成的核心叙事目标]
**情感基调**：[主要的情感氛围]
**情感发展**：[从什么情感状态发展到什么状态]
**关键任务**：
- 任务1：[具体要完成的内容]
- 任务2：[具体要完成的内容]
- 任务3：[具体要完成的内容]
**重要选择**：
- [选择情境]：[影响说明]
- [选择情境]：[影响说明]
**属性聚焦**：[此阶段重点展示哪些属性，列出具体属性，用逗号分开]
**角色发展**：[此阶段重点发展哪些角色关系]
**结局铺垫**：[如何为多结局建立基础]

### 阶段二：[阶段名称]
**章节范围**：第[起始章]-[结束章]章
**核心目标**：[此阶段要达成的核心叙事目标]
**情感基调**：[主要的情感氛围]
**情感发展**：[从什么情感状态发展到什么状态]
**关键任务**：
- 任务1：[具体要完成的内容]
- 任务2：[具体要完成的内容]
- 任务3：[具体要完成的内容]
**重要选择**：
- [选择情境]：[影响说明]
- [选择情境]：[影响说明]
**属性聚焦**：[此阶段重点展示哪些属性，列出具体属性，用逗号分开]
**角色发展**：[此阶段重点发展哪些角色关系]
**结局铺垫**：[如何为多结局建立基础]

[根据实际阶段数量继续...]

---
**注意**：请确保所有章节编号、阶段范围与实际总章数 {total_chapters} 一致，避免出现超出范围的章节引用。
"""

def build_chapter_directory_prompt(
    core_seed: str,
    attribute_system: str,
    characters: str,
    architecture: str,
    total_chapters: int
) -> str:
    """
    构建章节目录生成提示词
    """
    return f"""
# 任务概述
你是一位专业的文字冒险游戏编剧，需要为{total_chapters}章的游戏生成具体的章节目录。

# 核心约束信息（必须严格遵守）

## 游戏核心设定
{core_seed}

## 游戏属性系统
{attribute_system}

## 主要角色设定
{characters}

# 完整叙事框架
{architecture}

# 生成内容
请你糅合以上所有要求和设定，设计出一个合理的章节目录。

# 生成要求

## 每章目录格式
每章必须严格按照以下格式输出，不要输出任何解释：
### 第X章 - [章节标题]
**本章定位**：[基于架构中的阶段定位，如"危机建立"/"关系深化"/"真相揭露"]
**情感基调**：[由阶段情感基调分析出本章具体的情感基调]
**核心作用**：
- 情节推进：[具体说明本章要推进什么情节]
- 属性展示：[展示哪些属性，如何展示]
- 关系发展：[发展哪些角色关系，如何发展]
**关键任务完成**：[本章完成架构中哪些关键任务]
**悬念设计**：[低/中/高] - [具体悬念描述]
**伏笔操作**：[埋设/强化/回收] [具体伏笔内容]
**选择点设计**：
- 位置1：[选择情境描述]
  → 选项A：[选项描述] [影响属性：属性名±值]
  → 选项B：[选项描述] [影响属性：属性名±值] 
- 位置2：[选择情境描述]
  → 选项A：[选项描述] [影响属性：属性名±值]
  → 选项B：[选项描述] [影响属性：属性名±值]
**章节大纲**：[100-150字的情节概要，确保与前后章衔接]

## 生成规则

### 结构遵守
- 必须严格遵循架构中的阶段划分和章节范围
- 每章的情感基调要符合所属阶段的情感基调描述
- 确保完成架构中为该阶段设定的关键任务

### 属性整合
- 每章至少重点展示1-2个属性
- 确保各属性在整个游戏中得到均衡展示机会

### 角色发展
- 每章至少与1-2个核心角色有深度互动
- 角色关系发展要符合架构中的路径规划

### 选择点设计原则
1. 每章1-2个选择点
2. 每个选择点提供2-3个选项
3. 每个选项的属性影响值保证在±2到±8点之间
4. 选项间体现不同的价值观倾向
5. 属性影响要合理且有意义
6. 该选择是否重大仅体现在对属性值的影响上，选择越重大，对属性值影响越大
7. 选择不会影响结局之前的主线剧情，仅在最后一章才会根据属性值判定多结局，确保选择后能在3句话内回归主线

### 技术实现约束
- 每章字数目标：2000字
- 特别注意：第{total_chapters}章（最后一章）必须设计为多结局模式。请在章节大纲中明确指出“本章将根据玩家属性达成不同结局”，并简要列举可能的结局方向（3-4个）（如：完美结局、普通结局、遗憾结局）。

# 输出格式
请生成{total_chapters}章的完整目录，从第1章到第{total_chapters}章，严格按照上述每章格式输出。
"""

def extract_chapter_from_directory(chapter_directory: str, chapter_index: int) -> str:
    """从章节目录文本中提取指定章节的详细设定信息"""
    if not chapter_directory:
        return "暂无目录信息"

    # ^(?:#+\s*)?  : 行首可选的 Markdown 标题标记 (#)
    # 第\s*(\d+)\s*章 : 匹配 "第1章", "第 1 章" 等，捕获数字
    pattern = re.compile(r"^(?:#+\s*)?第\s*(\d+)\s*章", re.MULTILINE)
    
    matches = list(pattern.finditer(chapter_directory))
    
    start_pos = -1
    end_pos = -1
    
    for i, m in enumerate(matches):
        try:
            idx = int(m.group(1))
        except ValueError:
            continue
            
        if idx == chapter_index:
            start_pos = m.start()
            # 结束位置是下一章的开始，或者是文本末尾
            if i + 1 < len(matches):
                end_pos = matches[i+1].start()
            else:
                end_pos = len(chapter_directory)
            break
            
    if start_pos != -1:
        return chapter_directory[start_pos:end_pos].strip()
    
    return f"（未在目录中找到第 {chapter_index} 章的详细设定，请根据全局架构自由发挥）"


def build_chapter_prompt(
    chapter_index: int,
    chapter_directory: str, 
    core_seed: str,
    attribute_system: str,
    characters: str, 
    architecture: str,
    previous_chapter_content: str = None,  
    global_summary: str = None  # 累积的全局摘要
) -> str:
    
    # 从章节目录提取本章特定信息
    chapter_info = extract_chapter_from_directory(chapter_directory, chapter_index)
    next_chapter_info = extract_chapter_from_directory(chapter_directory, chapter_index + 1)

    if "未在目录中找到" in next_chapter_info:
        next_chapter_info = "（这是最后一章或无下一章信息）"

    return f"""
# 任务概述
你正在创作文字冒险游戏的第 {chapter_index} 章。请基于以下设定生成具体章节剧情，特别注意将选择点自然地嵌入到对话和情境中。

{f'## 前文摘要\n{global_summary}\n' if global_summary else ''}
{f'## 前一章结尾\n{previous_chapter_content[-500:]}\n' if previous_chapter_content else ''}

## 本章定位
{chapter_info}

## 下一章定位
{next_chapter_info}

# 上下文信息

## 游戏核心设定
{core_seed}

## 主要角色设定
{characters}

## 完整属性系统
{attribute_system}

## 全局叙事架构
{architecture}

# 生成要求

## 优先级说明
- **最高优先级**：本章定位中的【章节大纲】。如果大纲内容与前文摘要、属性系统或其他设定有冲突，请**严格以章节大纲为准**进行剧情生成。

## 内容规范
- 叙事视角：主要使用第二人称（"你"）
- 字数范围：2000字左右
- 选择点数量：1-2个，自然分布在章节中
- 沉浸感：通过对话场景、动作场景、心里场景和环境描写等增强玩家代入感

## 选择点嵌入规范
选择点必须严格以下列格式嵌入在剧情中（属性影响四个字后面加属性名和值，属性名必须在属性系统之内）：
这里是前文剧情，引出玩家选择（选项在下一行）...
→ A. [选项描述] [影响属性：属性名±值]
[选择后的立即反应，2-3句话]
→ B. [选项描述] [影响属性：属性名±值]
[选择后的立即反应，2-3句话]
这里是后面的主线剧情，主线剧情与选项无关，请忽略玩家选择，自然过渡到下一个场景...

## 选择点设计规则
1. 该选择是否重大仅体现在对属性值的影响上，选择越重大，对属性值影响越大
2. 结局之前的主线剧情始终是线性的，不会因为玩家选择而影响主线剧情，确保每一个选择能在3句话内回归主线
3. 选择点必须出现在自然的对话或决策情境后，选项要体现角色性格和处境
4. 选择后的反应：2-3句话展示立即后果，然后自然回归主线
5. 确保选择点自然融入剧情，不要让玩家感觉选项是突兀插入的。

## 对话设计规范
- 对话要符合角色性格设定
- 通过对话自然引出决策点
- 对话中要体现角色关系和情感变化
- 避免冗长的独白，保持对话的互动性

# 输出格式
请严格按照以下格式输出：
第{chapter_index}章 - [章节标题]

### 剧情内容
[完整的叙事内容，包含嵌入的选择点]

"""

def build_last_chapter_with_endings_prompt(
    chapter_index: int,
    chapter_directory: str, 
    attribute_system: str,
    characters: str, 
    architecture: str,
    previous_chapter_content: str = None,  
    global_summary: str = None  # 累积的全局摘要
) -> str:
    chapter_info = extract_chapter_from_directory(chapter_directory, chapter_index)

    return f"""
# 任务概述
你正在创作文字冒险游戏的第 {chapter_index} 章（最终章），需要一次性完成两个部分：
1. 生成这一章的前半部分剧情（为多结局做铺垫，但不要实际展开结局）
2. 基于整个游戏内容设计3-4个不同的结局概述（根据属性系统判定）

{f'## 前文摘要\n{global_summary}\n' if global_summary else ''}
{f'## 前一章结尾\n{previous_chapter_content[-500:]}\n' if previous_chapter_content else ''}

## 本章定位
{chapter_info}

# 上下文信息

## 主要角色设定
{characters}

## 完整属性系统
{attribute_system}

## 全局叙事架构
{architecture}

# 生成要求

## 第一部分：最终章前半部分

### 内容规范
- **只生成这一章的前半部分**：剧情发展到即将进入结局的关键时刻就停止
- **不要生成任何结局内容**：结局将在第二部分概述
- **叙事视角**：主要使用第二人称（"你"）
- **字数范围**：1000-1500字（仅前半部分）
- **选择点数量**：0或1个，如果有，请安排在结局之前，进入结局时不再有选项
- **沉浸感**：通过对话场景、动作场景、心理描写和环境描写等增强玩家代入感

### 情感氛围
- 最后一章旨在根据玩家前面章节的选择判定结局，情感定位上并非重大选择时刻，而是揭示结局时刻，应水到渠成、自然过渡

### 选择点嵌入规范（如果有选择点）
选择点必须严格以下列格式嵌入在剧情中（选择点必须出现在自然的对话或决策情境后，属性影响四个字后面加属性名和值，属性名必须严格在属性系统之内）：
这里是前文剧情，引出玩家选择...
→ A. [选项描述] [影响属性：属性名±值]
[选择后的立即反应，2-3句话，不影响主线剧情]
→ B. [选项描述] [影响属性：属性名±值]
[选择后的立即反应，2-3句话，不影响主线剧情]
这里是后面的主线剧情，主线剧情与选项无关，请自然过渡，不要提选项相关的事，忽略玩家选择...

### 停止时机
- 当剧情发展到**结局触发点**时立即停止
- 结局触发点示例：真相揭示前、最终对决前等
- 不要描述任何结局结果，只需将玩家自然带到结局的门槛
- 确保所有结局都能自然地停止点展开

## 第二部分：结局概述设计

### 设计要求
1. **结局多样性**：设计3-4个结局，例如：
   - **完美结局**（高难度，属性要求高，圆满）
   - **普通结局**（中等难度，有得有失）
   - **缺憾/特殊结局**（特定属性偏科或较低，带有悲剧色彩或另类展开）
2. **判定逻辑**：基于【完整属性系统】中的属性设定合理的触发条件，条件只能为较高、中等或较低三个词中的一个。
   - 例如："勇气较高，智慧中等" 或 "心计较低"，注意用逗号分隔多个属性条件。严格遵循此格式。
   - 最后一个结局必须为默认结局，属性要求一栏为空。
3. **结局简述**：为每个结局提供150-200字左右的剧情梗概。

# 输出格式
请严格按照以下格式输出，不要解释任何内容：
第{chapter_index}章 - [章节标题]

#### 剧情内容
[仅包含前半部分的叙事内容，在结局触发点停止]

## 结局概述

### 结局1
**标题**：xxx
**属性要求**：勇气较高，智慧中等
**剧情概述**：[150-200字的剧情梗概]

### 结局2
**标题**：xxx
**属性要求**：心计较低
**剧情概述**：[150-200字的剧情梗概]

### 结局3
格式同上

[如果有其他结局，继续添加...]
"""

def build_ending_content_prompt(
    ending_title: str,
    ending_condition: str,
    ending_summary: str,
    chapter_index: int,
    architecture: str,
    attribute_system: str,
    characters: str,
    global_summary: str,
    previous_chapter_content: str, # 倒数第二章
    last_chapter_content: str # 最后一章前半部分
) -> str:
    return f"""
# 任务
你正在撰写文字冒险游戏剧情的最终章（第{chapter_index}章）。
这是一个特定的结局分支：{ending_title}。

# 触发条件
{ending_condition}

# 结局梗概
{ending_summary}

# 上下文信息

## 全局剧情摘要
{global_summary}

## 结局前提内容
{previous_chapter_content[-500:] if previous_chapter_content else ""}
{last_chapter_content}

## 完整属性系统
{attribute_system}

## 角色设定
{characters}

## 完整叙事架构
{architecture}

# 生成要求
1. **完整叙事**：紧跟【结局前提内容】，把【结局梗概】扩写成完整的结局（1500字左右）。
2. **情感收束**：回收之前的伏笔，对核心角色的命运给出交代。
3. **代入感**：使用第二人称“你”。
4. **无需选择点**：这是结局章节，不再包含新的分支选择。

# 输出格式
请直接输出扩写后的【结局梗概】，确保与【结局前提内容】自然衔接，不要有突兀的跳跃，不要任何解释。
"""

def update_summary_prompt(
    global_summary: str,
    new_chapter: str
) -> str:
    return f"""
# 任务
你是一位资深的文字冒险游戏剧情策划。请根据现有的前文摘要和最新一章的剧情更新摘要。

# 以下是新完成的章节文本：
{new_chapter}

# 以下是前文摘要（为空则说明现在是第一章）：
{global_summary}

# 要求：
- 保留既有重要信息，同时融入新剧情要点。
- 以简洁、连贯的语言描述剧情进展，仅关注剧情发展，忽略文本中给出的选项。
- 客观描绘，不展开联想或解释。
- 总字数控制在1000字以内。

仅返回更新后的前文摘要文本，不要解释任何内容。
"""

def build_cover_image_prompt_prompt(core_seed: str) -> str:
    """AI辅助构建生成作品封面的prompt
    """
    return f"""
# 角色
你是一位经验丰富的AI绘画提示词（Prompt）工程师，专精于将小说设定转化为高质量、高表现力、完整、全面的图像生成Prompt。

# 任务
你将收到一段小说（文字冒险游戏）的核心设定。你的任务是分析这段设定，并生成一个结构完整、细节丰富的图像生成Prompt，用于绘制这本小说的封面。

# 核心设定
{core_seed}

---

# Prompt生成指南

请严格按照以下结构，生成一个完整的、可以直接用于AI绘画工具的Prompt。你需要根据【核心设定】的内容，进行合理的推断和艺术化加工，填充到各个模块中。

## 1. 核心主题与氛围
- **一句话总结**：用一句话概括画面的核心主题和要传达的情绪。
- **关键词**：列出3-5个最能代表故事氛围的关键词（例如：史诗、神秘、浪漫、赛博朋克、复古、恐怖、希望）。

## 2. 画面主体与构图
- **主体**：明确画面的中心是谁或什么。描述主角/核心元素的外观、姿态、表情。
- **构图**：选择一个合适的构图方式（例如：中心构图、黄金分割、特写、远景），并描述视角（例如：仰视、俯视、平视）。

## 3. 环境与背景
- **场景**：描述主角所处的具体环境，包括建筑、自然景观等。
- **关键元素**：列出背景中必须出现的、与故事紧密相关的物品或符号（例如：一把剑、一朵奇特的花、一座漂浮的城堡）。

## 4. 艺术风格与媒介
- **风格**：选择一种最匹配的艺术风格（例如：日系动漫风、写实主义、水彩、油画、像素艺术、暗黑艺术）。
- **参考**：可以提及1-2位艺术家或风格作为参考（例如：风格类似宫崎骏，或类似《赛博朋克2077》的美术风格）。

## 5. 色彩与光影
- **色彩方案**：描述主色调和点缀色，以及它们如何营造氛围（例如：以冷色调为主，用暖色高光点缀）。
- **光影效果**：描述光线的来源和质感（例如：柔和的晨光、戏剧性的伦勃朗光、霓虹灯的冷光）。

## 6. 技术与质量词
- **技术参数**：添加通用的提升画质的关键词（例如：杰作, 最佳质量, 8k, 超精细细节, 复杂细节, 电影光效）。
- **画面比例**：默认使用 16:9。

# 最终输出要求
- 严格按照以上格式输出。
- 不要包含任何解释性文字，只输出最终的Prompt。
- 确保Prompt逻辑清晰，重点突出。
"""

def build_scene_image_prompt_prompt(chapter_content: str) -> str:
    """AI辅助构建生成场景画面的prompt
    """
    return f"""
# 角色
你是一位经验丰富的AI绘画提示词（Prompt）工程师，专精于将小说剧情转化为高质量、高表现力、完整、全面的图像生成Prompt。

# 任务
你将收到一段小说（文字冒险游戏）剧情的某一章节内容。你的任务是分析这段内容，将其按顺序合理切分为一个或多个画面单元（最少一个，最多三个），
并生成一个结构完整、细节丰富的图像生成Prompt，用于绘制场景背景图片。

# 章节剧情
{chapter_content}

# prompt生成指南
请严格按照以下结构，为每个画面单元生成一个完整的、可以直接用于AI绘画工具的Prompt。你需要根据【章节剧情】的内容，进行合理的推断和艺术化加工，填充到各个模块中。

## 画面1：

### 范围：[结束百分比]

### 核心主题与氛围
- 一句话总结：用一句话概括画面核心主题和人物要传达的情绪状态。
- 关键词：列出3-5个最能代表人物状态和故事氛围的关键词（例如：人物状态：孤独、坚毅、沉思、觉醒、忧郁；故事氛围：史诗、神秘、浪漫、赛博朋克、复古、恐怖、希望）。

### 画面主体与构图
- 人物主体：详细描述中心人物的外观特征、服装、姿态、面部表情和眼神。
- 构图方式：选择突出人物的构图（例如：人物中心构图、黄金分割构图、七分身像、面部特写、全身像）
- 视角选择：明确观察角度（例如：平视建立亲切感、仰视增强气势、俯视营造距离感）

### 环境与背景
- 场景设置：描述人物所处的具体环境，环境要与人物状态相呼应
- 场景元素：列出人物正在接触或与之互动的物品（例如：手持的武器、倚靠的墙壁、凝视的物品）以及背景中必须出现的、与故事紧密相关的物品或符号（例如：一把剑、一朵奇特的花、一座漂浮的城堡）

### 艺术风格与媒介
- 风格：选择最适合表现人物情感的艺术风格（例如：写实肖像、日系角色设计、古典油画、现代插画）。
- 参考：可以提及1-2位艺术家或风格作为参考（例如：风格类似宫崎骏，或类似《赛博朋克2077》的美术风格）。

### 色彩与光影
- 人物用色：描述人物服装、肤色的主色调，以及如何通过色彩突出人物
- 光影处理：重点描述人物身上的光影效果（例如：伦勃朗光突出面部轮廓、逆光营造神秘感、柔和光表现温柔）

### 技术与质量词
- 人物细节：添加强调人物细节的关键词（例如：精致五官、细腻皮肤纹理、服装褶皱细节、眼神光）
- 通用质量：杰作、最佳质量、8k、超精细细节、电影级光效
- 画面比例：16:9

## 画面2：

### 范围：[结束百分比]
（结构同上）

如果还有画面请继续...

# 特别注意
- 范围指的是百分数占比（但不带百分号），例如画面1范围是70即代表从开头持续到本章剧情字数的70%，画面2范围是100即代表从本章内容的70%持续到100%
- 最后一个画面的范围必须是100。
- 每个画面都要保持连贯性和逻辑顺序。
- 根据剧情的场景变化合理划分画面单元。
- 画面单元最少为 1 个，最多为 3 个。
- 忽略剧情文本中的选项相关信息（如果存在的话）。
- 确保每个Prompt都能独立生成高质量的背景图像。
- 直接按要求返回有效格式，不要任何解释。
"""

def build_report_prompt(
    global_summary: str,
    ending_summary: str,
    ending_title: str
) -> str:
    return f"""
# 任务
你是一位资深的文字冒险游戏剧情策划。请根据以下提供的全局剧情摘要和玩家达成的结局，生成详细的玩家个性报告。

# 全局剧情摘要
{global_summary}

# 达成结局
标题：{ending_title}
概述：{ending_summary}

# 报告要求
请生成一份个性化的结算报告，包含以下内容：
1. **称号**：一个四字或五字的独特称号，概括玩家在故事中的表现（如“宫心计谋家”、“末世独行者”）。
2. **评价**：一段100-150字的评价，以第二人称“你”的口吻，分析玩家的性格特点、决策风格以及在故事中的命运。
3. **特质**：提取3-4个关键词标签，描述玩家的核心特质（如“果敢”、“深谋远虑”、“仁慈”）。

# 输出格式
请严格按照以下格式输出，不要包含任何解释：
[称号]：xxxx
[评价]：xxxx
[特质]：xxxx, xxxx, xxxx
"""

import openai
text_client = openai.OpenAI(
    api_key="sk-PAF8gzAL93s9xKlaybzSQw", 
    base_url="https://llmapi.paratera.com/v1/"
)

def invoke(prompt: str) -> str:
    """调用文字API
    """
    response = text_client.chat.completions.create(
    model="DeepSeek-V3.2-Exp",  
    messages=[
        {
            "role": "user",
            "content": prompt        
        }
    ]
    )
    print(f"Invoke Result:\n{response.choices[0].message.content}")

if __name__ == "__main__":
    prompt = build_story_seed_prompt(["末世", "种田", "系统", "轻松"],"在末世里种田",12)
    print(prompt)
    print("\n")
    invoke(prompt)