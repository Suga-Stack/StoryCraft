upstream backend {
    server web:8000;
}

server {
    listen 80;
    server_name 82.157.231.8 localhost; 

    # === 前端静态文件服务 ===
    root /app/frontend; # 对应 docker-compose 中挂载的 frontend_assets
    index index.html;

    location / {
        # Vue Router history 模式支持：如果找不到文件，回退到 index.html
        try_files $uri $uri/ /index.html;
    }

    # === 后端静态资源 ===
    # Django 的静态文件 (admin样式等)
    location /static/ {
        alias /app/staticfiles/;
        expires 30d; 
        access_log off;
    }

    # 用户上传的媒体文件
    location /media/ {
        alias /app/media/;
        expires 30d; 
        access_log off;
    }

    # === 后端 API 转发 ===
    # 转发 API 请求
    location /api/ {
        proxy_pass http://backend;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
        client_max_body_size 20M; 
    }

    # 转发 Admin 管理后台
    location /admin/ {
        proxy_pass http://backend;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }

    # 转发 Swagger 文档
    location /swagger/ {
        proxy_pass http://backend;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }
    
    # 转发 DRF 登录视图 
    location /api-auth/ {
        proxy_pass http://backend;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_redirect off;
    }
}
